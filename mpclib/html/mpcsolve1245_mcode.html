<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="51,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">z</span>,<span class="var type1" id="S3T24U4">info</span>] = mpcsolve(<span class="var type1" id="S4T16U7">H</span>,<span class="var type1" id="S5T1U8">g</span>,<span class="var type1" id="S6T17U9">P</span>,<span class="var type1" id="S7T12U10">h</span>,<span class="var type1" id="S8T18U11">C</span>,<span class="var type1" id="S9T15U12">b</span>,<span class="var type1" id="S10T1U13">z0</span>,<span class="var type1" id="S11T19U14">A</span>,<span class="var type1" id="S12T3U15">B</span>,<span class="var type1" id="S13T20U16">Fx</span>,<span class="var type1" id="S14T21U17">Fu</span>,<span class="var type1" id="S15T22U18">Ff</span>,<span class="var type1" id="S16T19U19">Q</span>,<span class="var type1" id="S17T7U20">R</span>,<span class="var type1" id="S18T19U21">Qf</span>,<span class="var type1" id="S19T23U22">opts</span>,<span class="var type1" id="S20T16U23">Ps</span>,<span class="var type1" id="S21T1U24">hs</span>,<span class="var type1" id="S22T20U25">Ef</span>,<span class="var type1" id="S23T22U26">Fxs</span>,<span class="var type1" id="S24T24U27">Fus</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="51,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,3" id="srcline3">  3</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% sizes</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,5" id="srcline5">  5</a></span><span class="line"><span class="mxinfo " id="T7:U24"><span class="var type1" id="S25T7U30">n</span> = <span class="mxinfo " id="T7:U26">size(<span class="var type1" id="S11T19U33">A</span>,1)</span></span>; <span class="comment">% number of states in system</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,6" id="srcline6">  6</a></span><span class="line"><span class="mxinfo " id="T7:U28"><span class="var type1" id="S27T7U37">m</span> = <span class="mxinfo " id="T7:U30">size(<span class="var type1" id="S12T3U40">B</span>,2)</span></span>; <span class="comment">% number of inputs to system</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo " id="T7:U32"><span class="var type1" id="S28T7U44">nz</span> = <span class="mxinfo " id="T7:U34">length(<span class="var type1" id="S5T1U47">g</span>)</span></span>; <span class="comment">% number of decision variables in z</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,8" id="srcline8">  8</a></span><span class="line"><span class="mxinfo " id="T7:U36"><span class="var type1" id="S30T7U50">ne</span> = <span class="mxinfo " id="T7:U38">length(<span class="var type1" id="S9T15U53">b</span>)</span></span>; <span class="comment">% number of equalities in Cz=b</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,9" id="srcline9">  9</a></span><span class="line"><span class="mxinfo " id="T7:U40"><span class="var type1" id="S31T7U56">ni</span> = <span class="mxinfo " id="T7:U42">length(<span class="var type1" id="S7T12U59">h</span>)</span></span>; <span class="comment">% number of inequalities Pz&lt;=h</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo " id="T7:U44"><span class="var type1" id="S32T7U62">ns</span> = <span class="mxinfo " id="T7:U46">length(<span class="var type1" id="S21T1U65">hs</span>)</span></span>; <span class="comment">% number of soft constraints Ps*z&lt;=hs (if possible)</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,11" id="srcline11"> 11</a></span><span class="line"><span class="mxinfo " id="T7:U48"><span class="var type1" id="S33T7U68">ell</span> = <span class="mxinfo " id="T7:U50">size(<span class="var type1" id="S13T20U71">Fx</span>,1)</span></span>; <span class="comment">% number of inequalities per time step, Fx*x + Fu*u &lt;= f</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,12" id="srcline12"> 12</a></span><span class="line"><span class="mxinfo " id="T7:U52"><span class="var type1" id="S34T7U75">ells</span> = <span class="mxinfo " id="T7:U54">size(<span class="var type1" id="S23T22U78">Fxs</span>,1)</span></span>; <span class="comment">% number of soft constraints per time step, Fxs*x + Fus*u &lt;= fs</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo " id="T7:U56"><span class="var type1" id="S35T7U82">ellf</span> = <span class="mxinfo " id="T7:U58">size(<span class="var type1" id="S15T22U85">Ff</span>,1)</span></span>; <span class="comment">% number of terminal inequalities</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,14" id="srcline14"> 14</a></span><span class="line"><span class="mxinfo " id="T7:U60"><span class="var type1" id="S36T7U89">ellef</span> = <span class="mxinfo " id="T7:U62">size(<span class="var type1" id="S22T20U92">Ef</span>,1)</span></span>; <span class="comment">% number of terminal equalities</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,15" id="srcline15"> 15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">% important to take T (the horizon) from here</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% if you pass it in as a signal, code generator gets upset</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% as it thinks its matrices could vary in size</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,19" id="srcline19"> 19</a></span><span class="line"><span class="mxinfo " id="T7:U64"><span class="var type1" id="S37T7U96">T</span> = <span class="mxinfo " id="T7:U66">(<span class="var type1" id="S30T7U100">ne</span>-<span class="var type1" id="S36T7U101">ellef</span>)/size(<span class="var type1" id="S11T19U104">A</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,20" id="srcline20"> 20</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">% list of slack variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,22" id="srcline22"> 22</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S27T7U109">m</span>==3,</span></span>
<span class="srcline"><span class="lineno"><a href="51,23" id="srcline23"> 23</a></span><span class="line">    <span class="var type0" id="S38T0U113">slackList</span> = kron(ones(1,<span class="var type0" id="S37T0U120">T</span>),[2 3]) + kron((1:<span class="var type0" id="S37T0U131">T</span>)-1,[6 6]);</span></span>
<span class="srcline"><span class="lineno"><a href="51,24" id="srcline24"> 24</a></span><span class="line"><span class="keyword">elseif</span> <span class="var type1" id="S27T7U139">m</span>==2,</span></span>
<span class="srcline"><span class="lineno"><a href="51,25" id="srcline25"> 25</a></span><span class="line">    <span class="var type0" id="S38T0U143">slackList</span> = (2:5:(<span class="var type0" id="S37T0U151">T</span>*5));</span></span>
<span class="srcline"><span class="lineno"><a href="51,26" id="srcline26"> 26</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,27" id="srcline27"> 27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%% process options</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">% number of options passed in</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T7:U72"><span class="var type1" id="S41T7U155">nop</span> = <span class="mxinfo " id="T7:U74">length(<span class="var type1" id="S19T23U158">opts</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,32" id="srcline32"> 32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,33" id="srcline33"> 33</a></span><span class="line"><span class="comment">% option 1 - assume Phi is diagonal if &gt; 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,34" id="srcline34"> 34</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S41T7U162">nop</span>&gt;=1,</span></span>
<span class="srcline"><span class="lineno"><a href="51,35" id="srcline35"> 35</a></span><span class="line">    <span class="mxinfo " id="T4:U77"><span class="var type1" id="S42T4U166">flagPhiIsDiag</span> = <span class="mxinfo " id="T4:U79"><span class="mxinfo " id="T7:U80"><span class="var type1" id="S19T23U169">opts</span>(<span class="mxinfo " id="T7:U82">1</span>)</span>&gt;<span class="mxinfo " id="T7:U83">0</span></span></span>; <span class="comment">% turns on or off assumptions about diagonal Phi</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,36" id="srcline36"> 36</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,37" id="srcline37"> 37</a></span><span class="line">    <span class="var type0" id="S42T0U175">flagPhiIsDiag</span> = false; <span class="comment">% default setting does not assume diagonal</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,38" id="srcline38"> 38</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,39" id="srcline39"> 39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">% option 2 - set number of Newton iterations</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,41" id="srcline41"> 41</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S41T7U181">nop</span>&gt;=2,</span></span>
<span class="srcline"><span class="lineno"><a href="51,42" id="srcline42"> 42</a></span><span class="line">    <span class="mxinfo " id="T7:U85"><span class="var type1" id="S44T7U185">numNewtonIters</span> = <span class="mxinfo " id="T7:U87"><span class="var type1" id="S19T23U187">opts</span>(<span class="mxinfo " id="T7:U89">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,43" id="srcline43"> 43</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,44" id="srcline44"> 44</a></span><span class="line">    <span class="var type0" id="S44T0U192">numNewtonIters</span> = 10;</span></span>
<span class="srcline"><span class="lineno"><a href="51,45" id="srcline45"> 45</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% option 3 - use KS function for soft constraints if &gt;0</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,48" id="srcline48"> 48</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S41T7U197">nop</span>&gt;=3,</span></span>
<span class="srcline"><span class="lineno"><a href="51,49" id="srcline49"> 49</a></span><span class="line">    <span class="mxinfo " id="T4:U91"><span class="var type1" id="S45T4U201">flagUseSoftCons</span> = <span class="mxinfo " id="T4:U93"><span class="mxinfo " id="T7:U94"><span class="var type1" id="S19T23U204">opts</span>(<span class="mxinfo " id="T7:U96">3</span>)</span>&gt;<span class="mxinfo " id="T7:U97">0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,50" id="srcline50"> 50</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,51" id="srcline51"> 51</a></span><span class="line">    <span class="var type0" id="S45T0U210">flagUseSoftCons</span> = false; <span class="comment">% default - ignore</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,52" id="srcline52"> 52</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,53" id="srcline53"> 53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% option 4 - enable massive amount of checking (slow) if &gt;0</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,55" id="srcline55"> 55</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S41T7U216">nop</span>&gt;=4,</span></span>
<span class="srcline"><span class="lineno"><a href="51,56" id="srcline56"> 56</a></span><span class="line">    <span class="mxinfo " id="T4:U99"><span class="var type1" id="S46T4U220">flagChecking</span> = <span class="mxinfo " id="T4:U101"><span class="mxinfo " id="T7:U102"><span class="var type1" id="S19T23U223">opts</span>(<span class="mxinfo " id="T7:U104">4</span>)</span>&gt;<span class="mxinfo " id="T7:U105">0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,57" id="srcline57"> 57</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,58" id="srcline58"> 58</a></span><span class="line">    <span class="var type0" id="S46T0U229">flagChecking</span> = false; <span class="comment">% default - ignore</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,59" id="srcline59"> 59</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,60" id="srcline60"> 60</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,61" id="srcline61"> 61</a></span><span class="line"><span class="comment">% option 5 - disable the Pade approximation if &gt;0</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,62" id="srcline62"> 62</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S41T7U235">nop</span>&gt;=5,</span></span>
<span class="srcline"><span class="lineno"><a href="51,63" id="srcline63"> 63</a></span><span class="line">    <span class="mxinfo " id="T4:U107"><span class="var type1" id="S47T4U239">flagNoPade</span> = <span class="mxinfo " id="T4:U109"><span class="mxinfo " id="T7:U110"><span class="var type1" id="S19T23U242">opts</span>(<span class="mxinfo " id="T7:U112">5</span>)</span>&gt;<span class="mxinfo " id="T7:U113">0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,64" id="srcline64"> 64</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,65" id="srcline65"> 65</a></span><span class="line">    <span class="var type0" id="S47T0U248">flagNoPade</span> = false; <span class="comment">% default - use Pade</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,66" id="srcline66"> 66</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% option 6 - norm tolerance for early stopping</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S41T7U254">nop</span>&gt;=6,</span></span>
<span class="srcline"><span class="lineno"><a href="51,70" id="srcline70"> 70</a></span><span class="line">    <span class="mxinfo " id="T7:U115"><span class="var type1" id="S48T7U258">termTol</span> = <span class="mxinfo " id="T7:U117"><span class="var type1" id="S19T23U260">opts</span>(<span class="mxinfo " id="T7:U119">6</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,71" id="srcline71"> 71</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,72" id="srcline72"> 72</a></span><span class="line">    <span class="var type0" id="S48T0U265">termTol</span> = 0; <span class="comment">% effectively use all iters</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,73" id="srcline73"> 73</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,74" id="srcline74"> 74</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%% settings</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,76" id="srcline76"> 76</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">% single fixed barrier weight</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,78" id="srcline78"> 78</a></span><span class="line"><span class="mxinfo " id="T7:U120"><span class="var type1" id="S49T7U269">kappa</span> = <span class="mxinfo " id="T7:U122">0.002</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,79" id="srcline79"> 79</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,80" id="srcline80"> 80</a></span><span class="line"><span class="comment">% fixed parameter for KS-function</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,81" id="srcline81"> 81</a></span><span class="line"><span class="mxinfo " id="T7:U123"><span class="var type1" id="S50T7U273">rho</span>=<span class="mxinfo " id="T7:U125">10</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,82" id="srcline82"> 82</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">%% precalculations</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,84" id="srcline84"> 84</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,85" id="srcline85"> 85</a></span><span class="line"><span class="comment">% preform to avoid later work</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,86" id="srcline86"> 86</a></span><span class="line"><span class="mxinfo " id="T27:U126"><span class="var type1" id="S51T27U277">kappaPt</span> = <span class="mxinfo " id="T27:U128"><span class="mxinfo " id="T7:U129"><span class="var type1" id="S49T7U279">kappa</span></span>*<span class="mxinfo " id="T27:U131"><span class="var type1" id="S6T17U281">P</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,87" id="srcline87"> 87</a></span><span class="line"><span class="mxinfo " id="T27:U133"><span class="var type1" id="S52T27U284">kappaPtSq</span> = <span class="mxinfo " id="T27:U135"><span class="var type1" id="S51T27U286">kappaPt</span>.*<span class="mxinfo " id="T27:U137"><span class="var type1" id="S6T17U288">P</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,88" id="srcline88"> 88</a></span><span class="line"><span class="mxinfo " id="T16:U139"><span class="var type1" id="S53T16U291">rhoPstSq</span> = <span class="mxinfo " id="T16:U141"><span class="mxinfo " id="T16:U142"><span class="mxinfo " id="T7:U143"><span class="var type1" id="S50T7U294">rho</span></span>*<span class="mxinfo " id="T16:U145"><span class="var type1" id="S20T16U296">Ps</span>'</span></span>.*<span class="mxinfo " id="T16:U147"><span class="var type1" id="S20T16U298">Ps</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,89" id="srcline89"> 89</a></span><span class="line"><span class="mxinfo " id="T1:U149"><span class="var type1" id="S54T1U301">diagTwoH</span> = <span class="mxinfo " id="T1:U151">diag(<span class="mxinfo " id="T16:U152"><span class="mxinfo " id="T7:U153">2</span>*<span class="var type1" id="S4T16U306">H</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,90" id="srcline90"> 90</a></span><span class="line"><span class="comment">% helpful to avoid lots of blkdiag calls later</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,91" id="srcline91"> 91</a></span><span class="line"><span class="mxinfo " id="T33:U155"><span class="var type1" id="S56T33U309">blkQR</span> = <span class="mxinfo " id="T33:U157">blkdiag(<span class="var type1" id="S16T19U312">Q</span>,<span class="var type1" id="S17T7U313">R</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,92" id="srcline92"> 92</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,93" id="srcline93"> 93</a></span><span class="line"><span class="comment">% pre-allocate for KS residuals</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,94" id="srcline94"> 94</a></span><span class="line"><span class="mxinfo " id="T1:U160"><span class="var type1" id="S58T1U316">es</span> = <span class="var type1" id="S21T1U317">hs</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,95" id="srcline95"> 95</a></span><span class="line"><span class="mxinfo " id="T1:U163"><span class="var type1" id="S59T1U320">ds</span> = <span class="var type1" id="S21T1U321">hs</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,96" id="srcline96"> 96</a></span><span class="line"><span class="mxinfo " id="T1:U166"><span class="var type1" id="S60T1U324">dsNew</span> = <span class="var type1" id="S59T1U325">ds</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,97" id="srcline97"> 97</a></span><span class="line"><span class="mxinfo " id="T1:U169"><span class="var type1" id="S61T1U328">esNew</span> = <span class="var type1" id="S58T1U329">es</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,98" id="srcline98"> 98</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">% pre-assignment to keep coder happy</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,100" id="srcline100">100</a></span><span class="line"><span class="mxinfo " id="T1:U172"><span class="var type1" id="S62T1U332">dz</span> = <span class="mxinfo " id="T1:U174">zeros(<span class="mxinfo " id="T7:U175"><span class="var type1" id="S28T7U335">nz</span></span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,101" id="srcline101">101</a></span><span class="line"><span class="mxinfo " id="T16:U177"><span class="var type1" id="S64T16U339">phi</span> = <span class="mxinfo " id="T16:U179">zeros(<span class="mxinfo " id="T7:U180"><span class="var type1" id="S28T7U342">nz</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,102" id="srcline102">102</a></span><span class="line"><span class="mxinfo " id="T1:U182"><span class="var type1" id="S65T1U345">dhats</span> = <span class="mxinfo " id="T1:U184">zeros(<span class="mxinfo " id="T7:U185"><span class="var type1" id="S32T7U348">ns</span></span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,103" id="srcline103">103</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,104" id="srcline104">104</a></span><span class="line"><span class="comment">%% form initial solution</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,105" id="srcline105">105</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,106" id="srcline106">106</a></span><span class="line"><span class="comment">% form the tail of the previous solution</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,107" id="srcline107">107</a></span><span class="line"><span class="comment">% plus a step of zero control on the end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,108" id="srcline108">108</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S27T7U353">m</span>==1, <span class="comment">% hack - catch the slack case</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,109" id="srcline109">109</a></span><span class="line">    <span class="comment">% no slacks - ok for zeros at end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,110" id="srcline110">110</a></span><span class="line">    <span class="mxinfo " id="T1:U188"><span class="var type1" id="S66T1U357">zTail</span> = <span class="mxinfo " id="T1:U190">[<span class="mxinfo " id="T80:U191"><span class="var type1" id="S10T1U361">z0</span>(<span class="mxinfo " id="T81:U193">(<span class="mxinfo " id="T7:U194"><span class="var type1" id="S27T7U366">m</span>+<span class="var type1" id="S25T7U367">n</span>+1</span>):<span class="mxinfo " id="T7:U197"><span class="var type1" id="S28T7U369">nz</span></span></span>)</span>; <span class="mxinfo " id="T7:U199">zeros(<span class="var type1" id="S27T7U373">m</span>,1)</span>; <span class="mxinfo " id="T3:U201"><span class="var type1" id="S11T19U377">A</span>*<span class="mxinfo " id="T3:U203"><span class="var type1" id="S10T1U379">z0</span>(<span class="mxinfo " id="T36:U205"><span class="mxinfo " id="T7:U206"><span class="var type1" id="S28T7U382">nz</span> - <span class="var type1" id="S25T7U383">n</span></span> + (<span class="mxinfo " id="T36:U209">1:<span class="var type1" id="S25T7U387">n</span></span>)</span>)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,111" id="srcline111">111</a></span><span class="line"><span class="keyword">else</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,112" id="srcline112">112</a></span><span class="line">    <span class="comment">% slacks = can't be exactly zero</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,113" id="srcline113">113</a></span><span class="line">    <span class="var type0" id="S66T0U391">zTail</span> = [<span class="var type0" id="S10T0U395">z0</span>((<span class="var type0" id="S27T0U400">m</span>+<span class="var type0" id="S25T0U401">n</span>+1):<span class="var type0" id="S28T0U403">nz</span>); [0; 0.0001*zeros(<span class="var type0" id="S27T0U414">m</span>-1,1) ]; <span class="var type0" id="S11T0U419">A</span>*<span class="var type0" id="S10T0U421">z0</span>(<span class="var type0" id="S28T0U424">nz</span> - <span class="var type0" id="S25T0U425">n</span> + (1:<span class="var type0" id="S25T0U429">n</span>))];</span></span>
<span class="srcline"><span class="lineno"><a href="51,114" id="srcline114">114</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,115" id="srcline115">115</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,116" id="srcline116">116</a></span><span class="line"><span class="comment">% check if tail works as an initializer</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,117" id="srcline117">117</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T4:U211">all(<span class="mxinfo " id="T37:U212"><span class="mxinfo " id="T12:U213"><span class="var type1" id="S6T17U436">P</span>*<span class="var type1" id="S66T1U437">zTail</span></span>&lt;<span class="var type1" id="S7T12U438">h</span></span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,118" id="srcline118">118</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,119" id="srcline119">119</a></span><span class="line">    <span class="comment">% tail is feasible</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,120" id="srcline120">120</a></span><span class="line">    <span class="mxinfo " id="T1:U217"><span class="var type1" id="S2T1U441">z</span> = <span class="var type1" id="S66T1U442">zTail</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,121" id="srcline121">121</a></span><span class="line">    <span class="mxinfo " id="T7:U220"><span class="var type1" id="S68T7U445">initSolChoice</span> = <span class="mxinfo " id="T7:U222">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,122" id="srcline122">122</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,123" id="srcline123">123</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,124" id="srcline124">124</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,125" id="srcline125">125</a></span><span class="line">    <span class="comment">% try fiddling with the slack variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,126" id="srcline126">126</a></span><span class="line">    <span class="mxinfo " id="T1:U223"><span class="var type1" id="S2T1U450">z</span> = <span class="var type1" id="S66T1U451">zTail</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,127" id="srcline127">127</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,128" id="srcline128">128</a></span><span class="line">    <span class="comment">% catch just the slack case</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,129" id="srcline129">129</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S27T7U455">m</span>&gt;1,</span></span>
<span class="srcline"><span class="lineno"><a href="51,130" id="srcline130">130</a></span><span class="line">        <span class="var type0" id="S2T0U460">z</span>(<span class="var type0" id="S38T0U461">slackList</span>) = -1.0001*min(<span class="var type0" id="S6T0U469">P</span>*<span class="var type0" id="S2T0U470">z</span> - <span class="var type0" id="S7T0U471">h</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="51,131" id="srcline131">131</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,132" id="srcline132">132</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,133" id="srcline133">133</a></span><span class="line">    <span class="comment">% now check if that worked</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,134" id="srcline134">134</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T4:U227">all(<span class="mxinfo " id="T37:U228"><span class="mxinfo " id="T12:U229"><span class="var type1" id="S6T17U478">P</span>*<span class="var type1" id="S2T1U479">z</span></span>&lt;<span class="var type1" id="S7T12U480">h</span></span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,135" id="srcline135">135</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,136" id="srcline136">136</a></span><span class="line">        <span class="comment">% worked</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,137" id="srcline137">137</a></span><span class="line">        <span class="mxinfo " id="T7:U233"><span class="var type1" id="S68T7U483">initSolChoice</span> = <span class="mxinfo " id="T7:U235">4</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,138" id="srcline138">138</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,139" id="srcline139">139</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T4:U236">all(<span class="mxinfo " id="T37:U237"><span class="mxinfo " id="T12:U238"><span class="var type1" id="S6T17U490">P</span>*<span class="var type1" id="S10T1U491">z0</span></span>&lt;<span class="var type1" id="S7T12U492">h</span></span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,140" id="srcline140">140</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,141" id="srcline141">141</a></span><span class="line">        <span class="comment">% try last solution unchanged</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,142" id="srcline142">142</a></span><span class="line">        <span class="mxinfo " id="T1:U242"><span class="var type1" id="S2T1U495">z</span> = <span class="var type1" id="S10T1U496">z0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,143" id="srcline143">143</a></span><span class="line">        <span class="mxinfo " id="T7:U245"><span class="var type1" id="S68T7U499">initSolChoice</span> = <span class="mxinfo " id="T7:U247">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,144" id="srcline144">144</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,145" id="srcline145">145</a></span><span class="line">    <span class="keyword">elseif</span> <span class="mxinfo " id="T4:U248">all(<span class="mxinfo " id="T37:U249"><span class="mxinfo " id="T7:U250">0</span>&lt;<span class="var type1" id="S7T12U506">h</span></span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,146" id="srcline146">146</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,147" id="srcline147">147</a></span><span class="line">        <span class="comment">% in this case, start with zeros</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,148" id="srcline148">148</a></span><span class="line">        <span class="mxinfo " id="T1:U252"><span class="var type1" id="S2T1U509">z</span> = <span class="mxinfo " id="T1:U254">zeros(size(<span class="var type1" id="S10T1U514">z0</span>))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,149" id="srcline149">149</a></span><span class="line">        <span class="mxinfo " id="T7:U256"><span class="var type1" id="S68T7U517">initSolChoice</span> = <span class="mxinfo " id="T7:U258">3</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,150" id="srcline150">150</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,151" id="srcline151">151</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,152" id="srcline152">152</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,153" id="srcline153">153</a></span><span class="line">        <span class="comment">% out of ideas - zeros anyway</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,154" id="srcline154">154</a></span><span class="line">        <span class="mxinfo " id="T1:U259"><span class="var type1" id="S2T1U522">z</span> = <span class="mxinfo " id="T1:U261">zeros(size(<span class="var type1" id="S10T1U527">z0</span>))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,155" id="srcline155">155</a></span><span class="line">        <span class="mxinfo " id="T7:U263"><span class="var type1" id="S68T7U530">initSolChoice</span> = <span class="mxinfo " id="T7:U265">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,156" id="srcline156">156</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,157" id="srcline157">157</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,158" id="srcline158">158</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,159" id="srcline159">159</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,160" id="srcline160">160</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,161" id="srcline161">161</a></span><span class="line"><span class="comment">%% initialization</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,162" id="srcline162">162</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,163" id="srcline163">163</a></span><span class="line"><span class="comment">% initial lagrange multipliers</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,164" id="srcline164">164</a></span><span class="line"><span class="mxinfo " id="T15:U266"><span class="var type1" id="S70T15U534">nu</span> = <span class="mxinfo " id="T15:U268">zeros(<span class="var type1" id="S30T7U537">ne</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,165" id="srcline165">165</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,166" id="srcline166">166</a></span><span class="line"><span class="comment">% precalculate d</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,167" id="srcline167">167</a></span><span class="line"><span class="mxinfo " id="T12:U270"><span class="var type1" id="S71T12U541">d</span> = <span class="mxinfo " id="T12:U272"><span class="mxinfo " id="T7:U273">1</span>./(<span class="mxinfo " id="T12:U274"><span class="var type1" id="S7T12U546">h</span> - <span class="mxinfo " id="T12:U276"><span class="fcn" id="F237N10:B548">multByP</span>(<span class="var type1" id="S2T1U549">z</span>,<span class="var type1" id="S13T20U550">Fx</span>,<span class="var type1" id="S14T21U551">Fu</span>,<span class="var type1" id="S15T22U552">Ff</span>,<span class="var type1" id="S37T7U553">T</span>,<span class="var type1" id="S25T7U554">n</span>,<span class="var type1" id="S27T7U555">m</span>,<span class="var type1" id="S33T7U556">ell</span>,<span class="var type1" id="S35T7U557">ellf</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,168" id="srcline168">168</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,169" id="srcline169">169</a></span><span class="line"><span class="comment">% calculate residuals for first iteration</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,170" id="srcline170">170</a></span><span class="line"><span class="mxinfo " id="T15:U286"><span class="var type1" id="S73T15U560">rp</span> = <span class="mxinfo " id="T15:U288"><span class="fcn" id="F247N7:B562">calcRp</span>(<span class="var type1" id="S2T1U563">z</span>,<span class="var type1" id="S9T15U564">b</span>,<span class="var type1" id="S11T19U565">A</span>,<span class="var type1" id="S12T3U566">B</span>,<span class="var type1" id="S22T20U567">Ef</span>,<span class="var type1" id="S37T7U568">T</span>,<span class="var type1" id="S25T7U569">n</span>,<span class="var type1" id="S27T7U570">m</span>,<span class="var type1" id="S36T7U571">ellef</span>)</span></span>; <span class="comment">%C*z - b;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,171" id="srcline171">171</a></span><span class="line"><span class="mxinfo " id="T7:U298"><span class="var type1" id="S75T7U574">rpMag</span> = <span class="mxinfo " id="T7:U300">norm(<span class="var type1" id="S73T15U577">rp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,172" id="srcline172">172</a></span><span class="line"><span class="mxinfo " id="T1:U302"><span class="var type1" id="S77T1U580">rd</span> = <span class="mxinfo " id="T1:U304"><span class="mxinfo " id="T1:U305"><span class="mxinfo " id="T1:U306"><span class="mxinfo " id="T1:U307"><span class="var type1" id="S54T1U585">diagTwoH</span>.*<span class="var type1" id="S2T1U586">z</span></span> + <span class="var type1" id="S5T1U587">g</span></span> + <span class="mxinfo " id="T1:U311"><span class="var type1" id="S51T27U589">kappaPt</span>*<span class="var type1" id="S71T12U590">d</span></span></span> + <span class="mxinfo " id="T1:U314"><span class="mxinfo " id="T43:U315"><span class="var type1" id="S8T18U593">C</span>'</span>*<span class="mxinfo " id="T15:U317"><span class="var type1" id="S70T15U594">nu</span></span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,173" id="srcline173">173</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,174" id="srcline174">174</a></span><span class="line"><span class="comment">% optional soft constraint info</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,175" id="srcline175">175</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S45T4U597">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,176" id="srcline176">176</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,177" id="srcline177">177</a></span><span class="line">    <span class="comment">% evaluate soft version of d</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,178" id="srcline178">178</a></span><span class="line">    [<span class="mxinfo " id="T1:U320"><span class="var type1" id="S59T1U601">ds</span></span>,<span class="mxinfo " id="T1:U322"><span class="var type1" id="S58T1U602">es</span></span>]=<span class="fcn" id="F299N6:B604">calcDs</span>(<span class="var type1" id="S2T1U605">z</span>,<span class="var type1" id="S20T16U606">Ps</span>,<span class="var type1" id="S21T1U607">hs</span>,<span class="mxinfo " id="T7:U327"><span class="var type1" id="S50T7U608">rho</span></span>,<span class="var type1" id="S47T4U609">flagNoPade</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="51,179" id="srcline179">179</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,180" id="srcline180">180</a></span><span class="line">    <span class="comment">% add to residual</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,181" id="srcline181">181</a></span><span class="line">    <span class="mxinfo " id="T1:U330"><span class="var type1" id="S77T1U612">rd</span> = <span class="mxinfo " id="T1:U332"><span class="var type1" id="S77T1U614">rd</span> + <span class="mxinfo " id="T1:U334"><span class="mxinfo " id="T16:U335"><span class="var type1" id="S20T16U617">Ps</span>'</span>*<span class="var type1" id="S59T1U618">ds</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,182" id="srcline182">182</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,183" id="srcline183">183</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,184" id="srcline184">184</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,185" id="srcline185">185</a></span><span class="line"><span class="mxinfo " id="T7:U338"><span class="var type1" id="S79T7U621">rdMag</span> = <span class="mxinfo " id="T7:U340">norm(<span class="var type1" id="S77T1U624">rd</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,186" id="srcline186">186</a></span><span class="line"><span class="mxinfo " id="T7:U342"><span class="var type1" id="S80T7U627">rMag</span> = <span class="mxinfo " id="T7:U344">norm(<span class="mxinfo " id="T21:U345">[<span class="var type1" id="S79T7U632">rdMag</span>;<span class="var type1" id="S75T7U634">rpMag</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,187" id="srcline187">187</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,188" id="srcline188">188</a></span><span class="line"><span class="comment">%% main solution loop for Newton's method</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,189" id="srcline189">189</a></span><span class="line"><span class="mxinfo " id="T7:U348"><span class="var type1" id="S81T7U637">iterCount</span> = <span class="var type1" id="S44T7U638">numNewtonIters</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,190" id="srcline190">190</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S82T7U641">kk</span>=<span class="mxinfo " id="T7:U352">1</span>:<span class="var type1" id="S44T7U644">numNewtonIters</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,191" id="srcline191">191</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,192" id="srcline192">192</a></span><span class="line">    <span class="comment">% check the P multiplier</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,193" id="srcline193">193</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U647">flagChecking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,194" id="srcline194">194</a></span><span class="line">        <span class="mxinfo " id="T7:U355"><span class="var type1" id="S83T7U650">check_d</span> = <span class="mxinfo " id="T7:U357">norm(<span class="mxinfo " id="T12:U358"><span class="var type1" id="S71T12U654">d</span> - (<span class="mxinfo " id="T12:U360"><span class="mxinfo " id="T7:U361">1</span>./(<span class="mxinfo " id="T12:U362"><span class="var type1" id="S7T12U660">h</span> - <span class="mxinfo " id="T12:U364"><span class="var type1" id="S6T17U662">P</span>*<span class="var type1" id="S2T1U663">z</span></span></span>)</span>)</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,195" id="srcline195">195</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,196" id="srcline196">196</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,197" id="srcline197">197</a></span><span class="line">    <span class="comment">% check residual calc</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,198" id="srcline198">198</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U666">flagChecking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,199" id="srcline199">199</a></span><span class="line">        <span class="mxinfo " id="T7:U368"><span class="var type1" id="S84T7U669">checkRp</span> = <span class="mxinfo " id="T7:U370">norm(<span class="mxinfo " id="T15:U371"><span class="mxinfo " id="T15:U372"><span class="mxinfo " id="T15:U373"><span class="var type1" id="S8T18U675">C</span>*<span class="var type1" id="S2T1U676">z</span></span> - <span class="var type1" id="S9T15U677">b</span></span> - <span class="var type1" id="S73T15U678">rp</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,200" id="srcline200">200</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,201" id="srcline201">201</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,202" id="srcline202">202</a></span><span class="line">    <span class="comment">% if using soft cons with KS</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,203" id="srcline203">203</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S45T4U681">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,204" id="srcline204">204</a></span><span class="line">        <span class="comment">% need the "d-hat" for the second derivatives of the KS functions</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,205" id="srcline205">205</a></span><span class="line">        <span class="mxinfo " id="T1:U379"><span class="var type1" id="S65T1U684">dhats</span> = (<span class="mxinfo " id="T1:U381"><span class="var type1" id="S58T1U687">es</span> ./ (<span class="mxinfo " id="T1:U383">(<span class="mxinfo " id="T1:U384"><span class="mxinfo " id="T7:U385">1</span>+<span class="var type1" id="S58T1U693">es</span></span>).*(<span class="mxinfo " id="T1:U387"><span class="mxinfo " id="T7:U388">1</span>+<span class="var type1" id="S58T1U697">es</span></span>)</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,206" id="srcline206">206</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,207" id="srcline207">207</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,208" id="srcline208">208</a></span><span class="line">    <span class="comment">% first form inverse of Phi</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,209" id="srcline209">209</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S42T4U700">flagPhiIsDiag</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,210" id="srcline210">210</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,211" id="srcline211">211</a></span><span class="line">        <span class="comment">% form the diagonals of Phi</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,212" id="srcline212">212</a></span><span class="line">        <span class="mxinfo " id="T1:U391"><span class="var type1" id="S85T1U703">diagPhi</span> = <span class="mxinfo " id="T1:U393"><span class="var type1" id="S54T1U705">diagTwoH</span> + <span class="mxinfo " id="T1:U395"><span class="var type1" id="S52T27U707">kappaPtSq</span>*(<span class="mxinfo " id="T12:U397"><span class="var type1" id="S71T12U710">d</span>.*<span class="var type1" id="S71T12U711">d</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,213" id="srcline213">213</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,214" id="srcline214">214</a></span><span class="line">        <span class="comment">% plus soft cons if used</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,215" id="srcline215">215</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S45T4U714">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,216" id="srcline216">216</a></span><span class="line">            <span class="mxinfo " id="T1:U401"><span class="var type1" id="S85T1U717">diagPhi</span> = <span class="mxinfo " id="T1:U403"><span class="var type1" id="S85T1U719">diagPhi</span> + <span class="mxinfo " id="T1:U405"><span class="var type1" id="S53T16U721">rhoPstSq</span>*<span class="var type1" id="S65T1U722">dhats</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,217" id="srcline217">217</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,218" id="srcline218">218</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,219" id="srcline219">219</a></span><span class="line">        <span class="comment">% "invert" it</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,220" id="srcline220">220</a></span><span class="line">        <span class="mxinfo " id="T16:U408"><span class="var type1" id="S86T16U725">phiInv</span> = <span class="mxinfo " id="T16:U410">diag(<span class="mxinfo " id="T1:U411"><span class="mxinfo " id="T7:U412">1</span>./<span class="var type1" id="S85T1U730">diagPhi</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,221" id="srcline221">221</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,222" id="srcline222">222</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,223" id="srcline223">223</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,224" id="srcline224">224</a></span><span class="line">        <span class="comment">% preallocate to avoid slowdown</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,225" id="srcline225">225</a></span><span class="line">        <span class="mxinfo " id="T16:U414"><span class="var type1" id="S86T16U734">phiInv</span> = <span class="mxinfo " id="T16:U416">zeros(<span class="mxinfo " id="T7:U417"><span class="var type1" id="S28T7U737">nz</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,226" id="srcline226">226</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,227" id="srcline227">227</a></span><span class="line">        <span class="comment">% build the blocks of Phi inverse</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,228" id="srcline228">228</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S45T4U740">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,229" id="srcline229">229</a></span><span class="line">            <span class="mxinfo " id="T7:U420"><span class="mxinfo " id="T7:U421"><span class="var type1" id="S86T16U744">phiInv</span>(<span class="mxinfo " id="T7:U423">1:<span class="var type1" id="S27T7U747">m</span></span>,<span class="mxinfo " id="T7:U425">1:<span class="var type1" id="S27T7U750">m</span></span>)</span> = <span class="mxinfo " id="T7:U427"><span class="fcn" id="F512N11:B752">mySymPDinv</span>(<span class="mxinfo " id="T7:U428"><span class="mxinfo " id="T7:U429"><span class="mxinfo " id="T7:U430"><span class="mxinfo " id="T7:U431">2</span>*<span class="var type1" id="S17T7U757">R</span></span> + <span class="mxinfo " id="T7:U433"><span class="mxinfo " id="T28:U434"><span class="mxinfo " id="T28:U435"><span class="mxinfo " id="T7:U436"><span class="var type1" id="S49T7U761">kappa</span></span>*<span class="mxinfo " id="T28:U438"><span class="var type1" id="S14T21U763">Fu</span>'</span></span>*<span class="mxinfo " id="T44:U440">diag(<span class="mxinfo " id="T21:U441"><span class="mxinfo " id="T21:U442"><span class="var type1" id="S71T12U768">d</span>(<span class="mxinfo " id="T28:U444"><span class="mxinfo " id="T7:U445">1</span>:<span class="mxinfo " id="T7:U446"><span class="var type1" id="S33T7U771">ell</span></span></span>)</span>.*<span class="mxinfo " id="T21:U448"><span class="var type1" id="S71T12U773">d</span>(<span class="mxinfo " id="T28:U450"><span class="mxinfo " id="T7:U451">1</span>:<span class="mxinfo " id="T7:U452"><span class="var type1" id="S33T7U776">ell</span></span></span>)</span></span>)</span></span>*<span class="var type1" id="S14T21U777">Fu</span></span></span> + <span class="mxinfo " id="T7:U455"><span class="mxinfo " id="T42:U456"><span class="mxinfo " id="T42:U457"><span class="mxinfo " id="T7:U458"><span class="var type1" id="S50T7U781">rho</span></span>*<span class="mxinfo " id="T42:U460"><span class="var type1" id="S24T24U783">Fus</span>'</span></span>*<span class="mxinfo " id="T33:U462">diag(<span class="mxinfo " id="T24:U463"><span class="var type1" id="S65T1U787">dhats</span>(<span class="mxinfo " id="T42:U465"><span class="mxinfo " id="T7:U466">1</span>:<span class="mxinfo " id="T7:U467"><span class="var type1" id="S34T7U790">ells</span></span></span>)</span>)</span></span>*<span class="var type1" id="S24T24U791">Fus</span></span></span>,<span class="var type1" id="S46T4U792">flagChecking</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,230" id="srcline230">230</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,231" id="srcline231">231</a></span><span class="line">            <span class="mxinfo " id="T7:U471"><span class="mxinfo " id="T7:U472"><span class="var type1" id="S86T16U797">phiInv</span>(<span class="mxinfo " id="T7:U474">1:<span class="var type1" id="S27T7U800">m</span></span>,<span class="mxinfo " id="T7:U476">1:<span class="var type1" id="S27T7U803">m</span></span>)</span> = <span class="mxinfo " id="T7:U478"><span class="fcn" id="F512N11:B805">mySymPDinv</span>(<span class="mxinfo " id="T7:U479"><span class="mxinfo " id="T7:U480"><span class="mxinfo " id="T7:U481">2</span>*<span class="var type1" id="S17T7U809">R</span></span> + <span class="mxinfo " id="T7:U483"><span class="mxinfo " id="T28:U484"><span class="mxinfo " id="T28:U485"><span class="mxinfo " id="T7:U486"><span class="var type1" id="S49T7U813">kappa</span></span>*<span class="mxinfo " id="T28:U488"><span class="var type1" id="S14T21U815">Fu</span>'</span></span>*<span class="mxinfo " id="T44:U490">diag(<span class="mxinfo " id="T21:U491"><span class="mxinfo " id="T21:U492"><span class="var type1" id="S71T12U820">d</span>(<span class="mxinfo " id="T28:U494"><span class="mxinfo " id="T7:U495">1</span>:<span class="mxinfo " id="T7:U496"><span class="var type1" id="S33T7U823">ell</span></span></span>)</span>.*<span class="mxinfo " id="T21:U498"><span class="var type1" id="S71T12U825">d</span>(<span class="mxinfo " id="T28:U500"><span class="mxinfo " id="T7:U501">1</span>:<span class="mxinfo " id="T7:U502"><span class="var type1" id="S33T7U828">ell</span></span></span>)</span></span>)</span></span>*<span class="var type1" id="S14T21U829">Fu</span></span></span>,<span class="var type1" id="S46T4U830">flagChecking</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,232" id="srcline232">232</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,233" id="srcline233">233</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S88T7U833">ii</span>=<span class="mxinfo " id="T7:U507">1</span>:(<span class="var type1" id="S37T7U838">T</span>-1),</span></span>
<span class="srcline"><span class="lineno"><a href="51,234" id="srcline234">234</a></span><span class="line">            <span class="keyword">if</span> <span class="var type1" id="S45T4U842">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,235" id="srcline235">235</a></span><span class="line">                <span class="mxinfo " id="T33:U510"><span class="var type1" id="S89T33U845">blkInv</span> = <span class="mxinfo " id="T33:U512"><span class="fcn" id="F697N11:B847">mySymPDinv</span>(<span class="mxinfo " id="T33:U513"><span class="mxinfo " id="T33:U514"><span class="mxinfo " id="T33:U515"><span class="mxinfo " id="T7:U516">2</span>*<span class="var type1" id="S56T33U852">blkQR</span></span> + <span class="mxinfo " id="T33:U518"><span class="mxinfo " id="T57:U519"><span class="mxinfo " id="T57:U520"><span class="mxinfo " id="T7:U521"><span class="var type1" id="S49T7U856">kappa</span></span>*<span class="mxinfo " id="T57:U523"><span class="mxinfo " id="T58:U524">[<span class="var type1" id="S13T20U860">Fx</span> <span class="var type1" id="S14T21U861">Fu</span>]</span>'</span></span>*<span class="mxinfo " id="T44:U527">diag(<span class="mxinfo " id="T21:U528"><span class="mxinfo " id="T21:U529"><span class="var type1" id="S71T12U866">d</span>(<span class="mxinfo " id="T28:U531"><span class="mxinfo " id="T7:U532"><span class="var type1" id="S88T7U869">ii</span>*<span class="mxinfo " id="T7:U534"><span class="var type1" id="S33T7U870">ell</span></span></span> + (<span class="mxinfo " id="T28:U536">1:<span class="var type1" id="S33T7U874">ell</span></span>)</span>)</span>.*<span class="mxinfo " id="T21:U538"><span class="var type1" id="S71T12U876">d</span>(<span class="mxinfo " id="T28:U540"><span class="mxinfo " id="T7:U541"><span class="var type1" id="S88T7U879">ii</span>*<span class="mxinfo " id="T7:U543"><span class="var type1" id="S33T7U880">ell</span></span></span> + (<span class="mxinfo " id="T28:U545">1:<span class="var type1" id="S33T7U884">ell</span></span>)</span>)</span></span>)</span></span>*<span class="mxinfo " id="T58:U547">[<span class="var type1" id="S13T20U887">Fx</span> <span class="var type1" id="S14T21U888">Fu</span>]</span></span></span> + <span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,236" id="srcline236">236</a></span><span class="line"><span class="mxinfo " id="T33:U510"><span class="mxinfo " id="T33:U512"><span class="mxinfo " id="T33:U513">                    <span class="mxinfo " id="T33:U550"><span class="mxinfo " id="T33:U551"><span class="mxinfo " id="T33:U552"><span class="mxinfo " id="T7:U553"><span class="var type1" id="S50T7U892">rho</span></span>*<span class="mxinfo " id="T33:U555"><span class="mxinfo " id="T33:U556">[<span class="var type1" id="S23T22U896">Fxs</span> <span class="var type1" id="S24T24U897">Fus</span>]</span>'</span></span>*<span class="mxinfo " id="T33:U559">diag(<span class="mxinfo " id="T24:U560"><span class="var type1" id="S65T1U901">dhats</span>(<span class="mxinfo " id="T42:U562"><span class="mxinfo " id="T7:U563"><span class="var type1" id="S88T7U904">ii</span>*<span class="mxinfo " id="T7:U565"><span class="var type1" id="S34T7U905">ells</span></span></span> + (<span class="mxinfo " id="T42:U567">1:<span class="var type1" id="S34T7U909">ells</span></span>)</span>)</span>)</span></span>*<span class="mxinfo " id="T33:U569">[<span class="var type1" id="S23T22U912">Fxs</span> <span class="var type1" id="S24T24U913">Fus</span>]</span></span></span>,<span class="var type1" id="S46T4U914">flagChecking</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,237" id="srcline237">237</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,238" id="srcline238">238</a></span><span class="line">                <span class="mxinfo " id="T33:U573"><span class="var type1" id="S89T33U918">blkInv</span> = <span class="mxinfo " id="T33:U575"><span class="fcn" id="F697N11:B920">mySymPDinv</span>(<span class="mxinfo " id="T33:U576"><span class="mxinfo " id="T33:U577"><span class="mxinfo " id="T7:U578">2</span>*<span class="var type1" id="S56T33U924">blkQR</span></span> + <span class="mxinfo " id="T33:U580"><span class="mxinfo " id="T57:U581"><span class="mxinfo " id="T57:U582"><span class="mxinfo " id="T7:U583"><span class="var type1" id="S49T7U928">kappa</span></span>*<span class="mxinfo " id="T57:U585"><span class="mxinfo " id="T58:U586">[<span class="var type1" id="S13T20U932">Fx</span> <span class="var type1" id="S14T21U933">Fu</span>]</span>'</span></span>*<span class="mxinfo " id="T44:U589">diag(<span class="mxinfo " id="T21:U590"><span class="mxinfo " id="T21:U591"><span class="var type1" id="S71T12U938">d</span>(<span class="mxinfo " id="T28:U593"><span class="mxinfo " id="T7:U594"><span class="var type1" id="S88T7U941">ii</span>*<span class="mxinfo " id="T7:U596"><span class="var type1" id="S33T7U942">ell</span></span></span> + (<span class="mxinfo " id="T28:U598">1:<span class="var type1" id="S33T7U946">ell</span></span>)</span>)</span>.*<span class="mxinfo " id="T21:U600"><span class="var type1" id="S71T12U948">d</span>(<span class="mxinfo " id="T28:U602"><span class="mxinfo " id="T7:U603"><span class="var type1" id="S88T7U951">ii</span>*<span class="mxinfo " id="T7:U605"><span class="var type1" id="S33T7U952">ell</span></span></span> + (<span class="mxinfo " id="T28:U607">1:<span class="var type1" id="S33T7U956">ell</span></span>)</span>)</span></span>)</span></span>*<span class="mxinfo " id="T58:U609">[<span class="var type1" id="S13T20U959">Fx</span> <span class="var type1" id="S14T21U960">Fu</span>]</span></span></span>,<span class="var type1" id="S46T4U961">flagChecking</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,239" id="srcline239">239</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,240" id="srcline240">240</a></span><span class="line">            <span class="mxinfo " id="T33:U613"><span class="mxinfo " id="T33:U614"><span class="var type1" id="S86T16U965">phiInv</span>(<span class="mxinfo " id="T42:U616"><span class="mxinfo " id="T7:U617"><span class="var type1" id="S27T7U968">m</span>+<span class="mxinfo " id="T7:U619">(<span class="mxinfo " id="T7:U620"><span class="var type1" id="S88T7U972">ii</span>-<span class="mxinfo " id="T7:U622">1</span></span>)*(<span class="mxinfo " id="T7:U623"><span class="var type1" id="S25T7U976">n</span>+<span class="var type1" id="S27T7U977">m</span></span>)</span></span>+(<span class="mxinfo " id="T42:U626">1:(<span class="var type1" id="S25T7U983">n</span>+<span class="var type1" id="S27T7U984">m</span>)</span>)</span>,<span class="mxinfo " id="T42:U629"><span class="mxinfo " id="T7:U630"><span class="var type1" id="S27T7U987">m</span>+<span class="mxinfo " id="T7:U632">(<span class="mxinfo " id="T7:U633"><span class="var type1" id="S88T7U991">ii</span>-<span class="mxinfo " id="T7:U635">1</span></span>)*(<span class="mxinfo " id="T7:U636"><span class="var type1" id="S25T7U995">n</span>+<span class="var type1" id="S27T7U996">m</span></span>)</span></span>+(<span class="mxinfo " id="T42:U639">1:(<span class="var type1" id="S25T7U1002">n</span>+<span class="var type1" id="S27T7U1003">m</span>)</span>)</span>)</span> = <span class="var type1" id="S89T33U1004">blkInv</span></span>; <span class="comment">% [Q-tilde S-tilde; S-tilde' R-tilde]</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,241" id="srcline241">241</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,242" id="srcline242">242</a></span><span class="line">        <span class="mxinfo " id="T19:U643"><span class="mxinfo " id="T19:U644"><span class="var type1" id="S86T16U1008">phiInv</span>(<span class="mxinfo " id="T36:U646"><span class="mxinfo " id="T7:U647"><span class="var type1" id="S28T7U1011">nz</span>-<span class="var type1" id="S25T7U1012">n</span></span>+(<span class="mxinfo " id="T36:U650">1:<span class="var type1" id="S25T7U1016">n</span></span>)</span>,<span class="mxinfo " id="T36:U652"><span class="mxinfo " id="T7:U653"><span class="var type1" id="S28T7U1019">nz</span>-<span class="var type1" id="S25T7U1020">n</span></span>+(<span class="mxinfo " id="T36:U656">1:<span class="var type1" id="S25T7U1024">n</span></span>)</span>)</span> = <span class="mxinfo " id="T19:U658"><span class="fcn" id="F816N11:B1026">mySymPDinv</span>(<span class="mxinfo " id="T19:U659"><span class="mxinfo " id="T19:U660"><span class="mxinfo " id="T7:U661">2</span>*<span class="var type1" id="S18T19U1030">Qf</span></span> + <span class="mxinfo " id="T19:U663"><span class="mxinfo " id="T60:U664"><span class="mxinfo " id="T60:U665"><span class="mxinfo " id="T7:U666"><span class="var type1" id="S49T7U1034">kappa</span></span>*<span class="mxinfo " id="T60:U668"><span class="var type1" id="S15T22U1036">Ff</span>'</span></span>*<span class="mxinfo " id="T33:U670">diag(<span class="mxinfo " id="T24:U671"><span class="mxinfo " id="T24:U672"><span class="var type1" id="S71T12U1041">d</span>(<span class="mxinfo " id="T42:U674"><span class="mxinfo " id="T7:U675"><span class="mxinfo " id="T7:U676"><span class="var type1" id="S37T7U1044">T</span></span>*<span class="mxinfo " id="T7:U678"><span class="var type1" id="S33T7U1045">ell</span></span></span> + (<span class="mxinfo " id="T42:U680">1:<span class="var type1" id="S35T7U1049">ellf</span></span>)</span>)</span>.*<span class="mxinfo " id="T24:U682"><span class="var type1" id="S71T12U1051">d</span>(<span class="mxinfo " id="T42:U684"><span class="mxinfo " id="T7:U685"><span class="mxinfo " id="T7:U686"><span class="var type1" id="S37T7U1054">T</span></span>*<span class="mxinfo " id="T7:U688"><span class="var type1" id="S33T7U1055">ell</span></span></span> + (<span class="mxinfo " id="T42:U690">1:<span class="var type1" id="S35T7U1059">ellf</span></span>)</span>)</span></span>)</span></span>*<span class="var type1" id="S15T22U1060">Ff</span></span></span>,<span class="var type1" id="S46T4U1061">flagChecking</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,243" id="srcline243">243</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,244" id="srcline244">244</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,245" id="srcline245">245</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,246" id="srcline246">246</a></span><span class="line">    <span class="comment">% check phi inverted correctly</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,247" id="srcline247">247</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U1064">flagChecking</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,248" id="srcline248">248</a></span><span class="line">        <span class="mxinfo " id="T16:U695"><span class="var type1" id="S64T16U1067">phi</span> = <span class="mxinfo " id="T16:U697"><span class="mxinfo " id="T16:U698"><span class="mxinfo " id="T7:U699">2</span>*<span class="var type1" id="S4T16U1071">H</span></span> + <span class="mxinfo " id="T16:U701"><span class="mxinfo " id="T27:U702"><span class="mxinfo " id="T27:U703"><span class="mxinfo " id="T27:U704"><span class="mxinfo " id="T7:U705"><span class="var type1" id="S49T7U1076">kappa</span></span>*<span class="mxinfo " id="T27:U707"><span class="var type1" id="S6T17U1078">P</span>'</span></span>*<span class="mxinfo " id="T61:U709">diag(<span class="var type1" id="S71T12U1081">d</span>)</span></span>*<span class="mxinfo " id="T61:U711">diag(<span class="var type1" id="S71T12U1084">d</span>)</span></span>*<span class="var type1" id="S6T17U1085">P</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,249" id="srcline249">249</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S45T4U1088">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,250" id="srcline250">250</a></span><span class="line">            <span class="mxinfo " id="T16:U715"><span class="var type1" id="S64T16U1091">phi</span> = <span class="mxinfo " id="T16:U717"><span class="var type1" id="S64T16U1093">phi</span>+<span class="mxinfo " id="T16:U719"><span class="mxinfo " id="T16:U720"><span class="mxinfo " id="T16:U721"><span class="mxinfo " id="T7:U722"><span class="var type1" id="S50T7U1097">rho</span></span>*<span class="mxinfo " id="T16:U724"><span class="var type1" id="S20T16U1099">Ps</span>'</span></span>*<span class="mxinfo " id="T16:U726">diag(<span class="mxinfo " id="T1:U727"><span class="var type1" id="S58T1U1103">es</span> ./ (<span class="mxinfo " id="T1:U729">(<span class="mxinfo " id="T1:U730"><span class="mxinfo " id="T7:U731">1</span>+<span class="var type1" id="S58T1U1109">es</span></span>).*(<span class="mxinfo " id="T1:U733"><span class="mxinfo " id="T7:U734">1</span>+<span class="var type1" id="S58T1U1113">es</span></span>)</span>)</span>)</span></span>*<span class="var type1" id="S20T16U1114">Ps</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,251" id="srcline251">251</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,252" id="srcline252">252</a></span><span class="line">        <span class="mxinfo " id="T7:U737"><span class="var type1" id="S90T7U1117">checkPhiInv</span> = <span class="mxinfo " id="T7:U739">norm(<span class="mxinfo " id="T16:U740"><span class="mxinfo " id="T16:U741"><span class="var type1" id="S64T16U1122">phi</span>*<span class="var type1" id="S86T16U1123">phiInv</span></span> - <span class="mxinfo " id="T16:U744">eye(<span class="var type1" id="S28T7U1126">nz</span>)</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,253" id="srcline253">253</a></span><span class="line">        <span class="comment">%checkPhiInv = (phi*phiInv - eye(nz))</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,254" id="srcline254">254</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,255" id="srcline255">255</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,256" id="srcline256">256</a></span><span class="line">    <span class="comment">% preallocate Y</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,257" id="srcline257">257</a></span><span class="line">    <span class="mxinfo " id="T62:U746"><span class="var type1" id="S92T62U1129">Y</span> = <span class="mxinfo " id="T62:U748">zeros(<span class="mxinfo " id="T7:U749"><span class="var type1" id="S30T7U1132">ne</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,258" id="srcline258">258</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,259" id="srcline259">259</a></span><span class="line">    <span class="comment">% form the block elements of Y = C*phiInv*C'</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,260" id="srcline260">260</a></span><span class="line">    <span class="mxinfo " id="T19:U751"><span class="mxinfo " id="T19:U752"><span class="var type1" id="S92T62U1136">Y</span>(<span class="mxinfo " id="T36:U754"><span class="mxinfo " id="T7:U755">1</span>:<span class="mxinfo " id="T7:U756"><span class="var type1" id="S25T7U1139">n</span></span></span>,<span class="mxinfo " id="T36:U758"><span class="mxinfo " id="T7:U759">1</span>:<span class="mxinfo " id="T7:U760"><span class="var type1" id="S25T7U1142">n</span></span></span>)</span> = <span class="mxinfo " id="T19:U762"><span class="mxinfo " id="T19:U763"><span class="mxinfo " id="T3:U764"><span class="var type1" id="S12T3U1146">B</span>*<span class="mxinfo " id="T7:U766"><span class="fcn" id="F902N4:B1148">Rtil</span>(<span class="var type1" id="S86T16U1149">phiInv</span>,<span class="mxinfo " id="T7:U768">0</span>,<span class="mxinfo " id="T7:U769"><span class="var type1" id="S25T7U1151">n</span></span>,<span class="var type1" id="S27T7U1152">m</span>)</span></span>*<span class="mxinfo " id="T36:U772"><span class="var type1" id="S12T3U1154">B</span>'</span></span> + <span class="mxinfo " id="T19:U774"><span class="fcn" id="F908N3:B1156">Qtil</span>(<span class="var type1" id="S86T16U1157">phiInv</span>,<span class="mxinfo " id="T7:U776">1</span>,<span class="var type1" id="S25T7U1159">n</span>,<span class="mxinfo " id="T7:U778"><span class="var type1" id="S27T7U1160">m</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,261" id="srcline261">261</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S88T7U1163">ii</span>=<span class="mxinfo " id="T7:U781">1</span>:<span class="var type1" id="S37T7U1166">T</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,262" id="srcline262">262</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T4:U783"><span class="var type1" id="S88T7U1170">ii</span>&lt;<span class="var type1" id="S37T7U1171">T</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,263" id="srcline263">263</a></span><span class="line">            <span class="mxinfo " id="T19:U786"><span class="mxinfo " id="T19:U787"><span class="var type1" id="S92T62U1175">Y</span>(<span class="mxinfo " id="T36:U789"><span class="mxinfo " id="T7:U790">(<span class="mxinfo " id="T7:U791"><span class="var type1" id="S88T7U1180">ii</span>-<span class="mxinfo " id="T7:U793">1</span></span>)*<span class="mxinfo " id="T7:U794"><span class="var type1" id="S25T7U1182">n</span></span></span>+(<span class="mxinfo " id="T36:U796">1:<span class="var type1" id="S25T7U1186">n</span></span>)</span>,<span class="mxinfo " id="T36:U798"><span class="mxinfo " id="T7:U799"><span class="var type1" id="S88T7U1189">ii</span>*<span class="mxinfo " id="T7:U801"><span class="var type1" id="S25T7U1190">n</span></span></span>+(<span class="mxinfo " id="T36:U803">1:<span class="var type1" id="S25T7U1194">n</span></span>)</span>)</span> = <span class="mxinfo " id="T19:U805"><span class="mxinfo " id="T19:U806"><span class="mxinfo " id="T19:U807">-<span class="mxinfo " id="T19:U808"><span class="fcn" id="F908N3:B1199">Qtil</span>(<span class="var type1" id="S86T16U1200">phiInv</span>,<span class="var type1" id="S88T7U1201">ii</span>,<span class="var type1" id="S25T7U1202">n</span>,<span class="mxinfo " id="T7:U812"><span class="var type1" id="S27T7U1203">m</span></span>)</span></span>*<span class="mxinfo " id="T19:U814"><span class="var type1" id="S11T19U1205">A</span>'</span></span> - <span class="mxinfo " id="T19:U816"><span class="mxinfo " id="T3:U817"><span class="fcn" id="F911N5:B1208">Stil</span>(<span class="var type1" id="S86T16U1209">phiInv</span>,<span class="var type1" id="S88T7U1210">ii</span>,<span class="var type1" id="S25T7U1211">n</span>,<span class="var type1" id="S27T7U1212">m</span>)</span>*<span class="mxinfo " id="T36:U822"><span class="var type1" id="S12T3U1214">B</span>'</span></span></span></span>; <span class="comment">%Yabove(:,:,ii)</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,264" id="srcline264">264</a></span><span class="line">            <span class="mxinfo " id="T19:U824"><span class="mxinfo " id="T19:U825"><span class="var type1" id="S92T62U1218">Y</span>(<span class="mxinfo " id="T36:U827"><span class="mxinfo " id="T7:U828"><span class="var type1" id="S88T7U1221">ii</span>*<span class="mxinfo " id="T7:U830"><span class="var type1" id="S25T7U1222">n</span></span></span>+(<span class="mxinfo " id="T36:U832">1:<span class="var type1" id="S25T7U1226">n</span></span>)</span>,<span class="mxinfo " id="T36:U834"><span class="mxinfo " id="T7:U835">(<span class="mxinfo " id="T7:U836"><span class="var type1" id="S88T7U1231">ii</span>-<span class="mxinfo " id="T7:U838">1</span></span>)*<span class="mxinfo " id="T7:U839"><span class="var type1" id="S25T7U1233">n</span></span></span>+(<span class="mxinfo " id="T36:U841">1:<span class="var type1" id="S25T7U1237">n</span></span>)</span>)</span> = <span class="mxinfo " id="T19:U843"><span class="mxinfo " id="T19:U844"><span class="var type1" id="S92T62U1240">Y</span>(<span class="mxinfo " id="T36:U846"><span class="mxinfo " id="T7:U847">(<span class="mxinfo " id="T7:U848"><span class="var type1" id="S88T7U1245">ii</span>-<span class="mxinfo " id="T7:U850">1</span></span>)*<span class="mxinfo " id="T7:U851"><span class="var type1" id="S25T7U1247">n</span></span></span>+(<span class="mxinfo " id="T36:U853">1:<span class="var type1" id="S25T7U1251">n</span></span>)</span>,<span class="mxinfo " id="T36:U855"><span class="mxinfo " id="T7:U856"><span class="var type1" id="S88T7U1254">ii</span>*<span class="mxinfo " id="T7:U858"><span class="var type1" id="S25T7U1255">n</span></span></span>+(<span class="mxinfo " id="T36:U860">1:<span class="var type1" id="S25T7U1259">n</span></span>)</span>)</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,265" id="srcline265">265</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,266" id="srcline266">266</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T4:U862"><span class="var type1" id="S88T7U1263">ii</span>&gt;<span class="mxinfo " id="T7:U864">1</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,267" id="srcline267">267</a></span><span class="line">            <span class="mxinfo " id="T19:U865"><span class="var type1" id="S96T19U1267">tmp</span> = <span class="mxinfo " id="T19:U867"><span class="mxinfo " id="T3:U868"><span class="var type1" id="S11T19U1270">A</span>*<span class="mxinfo " id="T3:U870"><span class="fcn" id="F911N5:B1272">Stil</span>(<span class="var type1" id="S86T16U1273">phiInv</span>,<span class="mxinfo " id="T7:U872"><span class="var type1" id="S88T7U1275">ii</span>-<span class="mxinfo " id="T7:U874">1</span></span>,<span class="var type1" id="S25T7U1277">n</span>,<span class="var type1" id="S27T7U1278">m</span>)</span></span>*<span class="mxinfo " id="T36:U877"><span class="var type1" id="S12T3U1280">B</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,268" id="srcline268">268</a></span><span class="line">            <span class="mxinfo " id="T19:U879"><span class="mxinfo " id="T19:U880"><span class="var type1" id="S92T62U1284">Y</span>(<span class="mxinfo " id="T36:U882"><span class="mxinfo " id="T7:U883">(<span class="mxinfo " id="T7:U884"><span class="var type1" id="S88T7U1289">ii</span>-<span class="mxinfo " id="T7:U886">1</span></span>)*<span class="mxinfo " id="T7:U887"><span class="var type1" id="S25T7U1291">n</span></span></span>+(<span class="mxinfo " id="T36:U889">1:<span class="var type1" id="S25T7U1295">n</span></span>)</span>,<span class="mxinfo " id="T36:U891"><span class="mxinfo " id="T7:U892">(<span class="mxinfo " id="T7:U893"><span class="var type1" id="S88T7U1300">ii</span>-<span class="mxinfo " id="T7:U895">1</span></span>)*<span class="mxinfo " id="T7:U896"><span class="var type1" id="S25T7U1302">n</span></span></span>+(<span class="mxinfo " id="T36:U898">1:<span class="var type1" id="S25T7U1306">n</span></span>)</span>)</span> = <span class="mxinfo " id="T19:U900"><span class="mxinfo " id="T19:U901"><span class="mxinfo " id="T19:U902"><span class="mxinfo " id="T19:U903"><span class="mxinfo " id="T19:U904"><span class="mxinfo " id="T19:U905"><span class="var type1" id="S11T19U1313">A</span>*<span class="mxinfo " id="T19:U907"><span class="fcn" id="F908N3:B1315">Qtil</span>(<span class="var type1" id="S86T16U1316">phiInv</span>,<span class="mxinfo " id="T7:U909"><span class="var type1" id="S88T7U1318">ii</span>-<span class="mxinfo " id="T7:U911">1</span></span>,<span class="var type1" id="S25T7U1320">n</span>,<span class="mxinfo " id="T7:U913"><span class="var type1" id="S27T7U1321">m</span></span>)</span></span>*<span class="mxinfo " id="T19:U915"><span class="var type1" id="S11T19U1323">A</span>'</span></span> + <span class="var type1" id="S96T19U1324">tmp</span></span> + <span class="mxinfo " id="T19:U918"><span class="var type1" id="S96T19U1326">tmp</span>'</span></span> + <span class="mxinfo " id="T19:U920"><span class="mxinfo " id="T3:U921"><span class="var type1" id="S12T3U1329">B</span>*<span class="mxinfo " id="T7:U923"><span class="fcn" id="F902N4:B1331">Rtil</span>(<span class="var type1" id="S86T16U1332">phiInv</span>,<span class="mxinfo " id="T7:U925"><span class="var type1" id="S88T7U1334">ii</span>-<span class="mxinfo " id="T7:U927">1</span></span>,<span class="mxinfo " id="T7:U928"><span class="var type1" id="S25T7U1336">n</span></span>,<span class="var type1" id="S27T7U1337">m</span>)</span></span>*<span class="mxinfo " id="T36:U931"><span class="var type1" id="S12T3U1339">B</span>'</span></span></span> + <span class="mxinfo " id="T19:U933"><span class="fcn" id="F908N3:B1341">Qtil</span>(<span class="var type1" id="S86T16U1342">phiInv</span>,<span class="var type1" id="S88T7U1343">ii</span>,<span class="var type1" id="S25T7U1344">n</span>,<span class="mxinfo " id="T7:U937"><span class="var type1" id="S27T7U1345">m</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,269" id="srcline269">269</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,270" id="srcline270">270</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,271" id="srcline271">271</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,272" id="srcline272">272</a></span><span class="line">    <span class="comment">% add terms for terminal equality cons</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,273" id="srcline273">273</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S36T7U1349">ellef</span>&gt;0,</span></span>
<span class="srcline"><span class="lineno"><a href="51,274" id="srcline274">274</a></span><span class="line">        <span class="mxinfo " id="T63:U940"><span class="mxinfo " id="T63:U941"><span class="var type1" id="S92T62U1354">Y</span>(<span class="mxinfo " id="T36:U943"><span class="mxinfo " id="T7:U944">(<span class="mxinfo " id="T7:U945"><span class="var type1" id="S37T7U1359">T</span>-1</span>)*<span class="mxinfo " id="T7:U947"><span class="var type1" id="S25T7U1361">n</span></span></span>+(<span class="mxinfo " id="T36:U949">1:<span class="var type1" id="S25T7U1365">n</span></span>)</span>,<span class="mxinfo " id="T28:U951"><span class="mxinfo " id="T7:U952"><span class="mxinfo " id="T7:U953"><span class="var type1" id="S37T7U1368">T</span></span>*<span class="mxinfo " id="T7:U955"><span class="var type1" id="S25T7U1369">n</span></span></span>+(<span class="mxinfo " id="T28:U957">1:<span class="var type1" id="S36T7U1373">ellef</span></span>)</span>)</span> = <span class="mxinfo " id="T63:U959"><span class="mxinfo " id="T19:U960"><span class="fcn" id="F908N3:B1376">Qtil</span>(<span class="var type1" id="S86T16U1377">phiInv</span>,<span class="mxinfo " id="T7:U962"><span class="var type1" id="S37T7U1378">T</span></span>,<span class="var type1" id="S25T7U1379">n</span>,<span class="mxinfo " id="T7:U965"><span class="var type1" id="S27T7U1380">m</span></span>)</span>*<span class="mxinfo " id="T63:U967"><span class="var type1" id="S22T20U1382">Ef</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,275" id="srcline275">275</a></span><span class="line">        <span class="mxinfo " id="T20:U969"><span class="mxinfo " id="T20:U970"><span class="var type1" id="S92T62U1386">Y</span>(<span class="mxinfo " id="T28:U972"><span class="mxinfo " id="T7:U973"><span class="mxinfo " id="T7:U974"><span class="var type1" id="S37T7U1389">T</span></span>*<span class="mxinfo " id="T7:U976"><span class="var type1" id="S25T7U1390">n</span></span></span>+(<span class="mxinfo " id="T28:U978">1:<span class="var type1" id="S36T7U1394">ellef</span></span>)</span>,<span class="mxinfo " id="T36:U980"><span class="mxinfo " id="T7:U981">(<span class="mxinfo " id="T7:U982"><span class="var type1" id="S37T7U1399">T</span>-1</span>)*<span class="mxinfo " id="T7:U984"><span class="var type1" id="S25T7U1401">n</span></span></span>+(<span class="mxinfo " id="T36:U986">1:<span class="var type1" id="S25T7U1405">n</span></span>)</span>)</span> = <span class="mxinfo " id="T20:U988"><span class="mxinfo " id="T63:U989"><span class="var type1" id="S92T62U1408">Y</span>(<span class="mxinfo " id="T36:U991"><span class="mxinfo " id="T7:U992">(<span class="mxinfo " id="T7:U993"><span class="var type1" id="S37T7U1413">T</span>-1</span>)*<span class="mxinfo " id="T7:U995"><span class="var type1" id="S25T7U1415">n</span></span></span>+(<span class="mxinfo " id="T36:U997">1:<span class="var type1" id="S25T7U1419">n</span></span>)</span>,<span class="mxinfo " id="T28:U999"><span class="mxinfo " id="T7:U1000"><span class="mxinfo " id="T7:U1001"><span class="var type1" id="S37T7U1422">T</span></span>*<span class="mxinfo " id="T7:U1003"><span class="var type1" id="S25T7U1423">n</span></span></span>+(<span class="mxinfo " id="T28:U1005">1:<span class="var type1" id="S36T7U1427">ellef</span></span>)</span>)</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,276" id="srcline276">276</a></span><span class="line">        <span class="mxinfo " id="T44:U1007"><span class="mxinfo " id="T44:U1008"><span class="var type1" id="S92T62U1431">Y</span>(<span class="mxinfo " id="T28:U1010"><span class="mxinfo " id="T7:U1011"><span class="mxinfo " id="T7:U1012"><span class="var type1" id="S37T7U1434">T</span></span>*<span class="mxinfo " id="T7:U1014"><span class="var type1" id="S25T7U1435">n</span></span></span>+(<span class="mxinfo " id="T28:U1016">1:<span class="var type1" id="S36T7U1439">ellef</span></span>)</span>,<span class="mxinfo " id="T28:U1018"><span class="mxinfo " id="T7:U1019"><span class="mxinfo " id="T7:U1020"><span class="var type1" id="S37T7U1442">T</span></span>*<span class="mxinfo " id="T7:U1022"><span class="var type1" id="S25T7U1443">n</span></span></span>+(<span class="mxinfo " id="T28:U1024">1:<span class="var type1" id="S36T7U1447">ellef</span></span>)</span>)</span> = <span class="mxinfo " id="T44:U1026"><span class="var type1" id="S22T20U1449">Ef</span>*<span class="mxinfo " id="T63:U1028"><span class="var type1" id="S92T62U1451">Y</span>(<span class="mxinfo " id="T36:U1030"><span class="mxinfo " id="T7:U1031">(<span class="mxinfo " id="T7:U1032"><span class="var type1" id="S37T7U1456">T</span>-1</span>)*<span class="mxinfo " id="T7:U1034"><span class="var type1" id="S25T7U1458">n</span></span></span>+(<span class="mxinfo " id="T36:U1036">1:<span class="var type1" id="S25T7U1462">n</span></span>)</span>,<span class="mxinfo " id="T28:U1038"><span class="mxinfo " id="T7:U1039"><span class="mxinfo " id="T7:U1040"><span class="var type1" id="S37T7U1465">T</span></span>*<span class="mxinfo " id="T7:U1042"><span class="var type1" id="S25T7U1466">n</span></span></span>+(<span class="mxinfo " id="T28:U1044">1:<span class="var type1" id="S36T7U1470">ellef</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,277" id="srcline277">277</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,278" id="srcline278">278</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,279" id="srcline279">279</a></span><span class="line">    <span class="comment">% now check that Y was constructed correctly</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,280" id="srcline280">280</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U1473">flagChecking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,281" id="srcline281">281</a></span><span class="line">        <span class="mxinfo " id="T7:U1047"><span class="var type1" id="S97T7U1476">checkY</span> = <span class="mxinfo " id="T7:U1049">norm(<span class="mxinfo " id="T62:U1050"><span class="var type1" id="S92T62U1480">Y</span> - <span class="mxinfo " id="T62:U1052"><span class="mxinfo " id="T18:U1053"><span class="var type1" id="S8T18U1483">C</span>*<span class="var type1" id="S86T16U1484">phiInv</span></span>*<span class="mxinfo " id="T43:U1056"><span class="var type1" id="S8T18U1486">C</span>'</span></span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,282" id="srcline282">282</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,283" id="srcline283">283</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,284" id="srcline284">284</a></span><span class="line">    <span class="comment">% now form PhiInv * rd in preparation for making the RHS (-beta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,285" id="srcline285">285</a></span><span class="line">    <span class="mxinfo " id="T1:U1058"><span class="var type1" id="S98T1U1489">PhiInvRd</span> = <span class="mxinfo " id="T1:U1060">zeros(<span class="mxinfo " id="T7:U1061"><span class="var type1" id="S28T7U1492">nz</span></span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,286" id="srcline286">286</a></span><span class="line">    <span class="mxinfo " id="T7:U1063"><span class="mxinfo " id="T7:U1064"><span class="var type1" id="S98T1U1497">PhiInvRd</span>(<span class="mxinfo " id="T7:U1066">1:<span class="var type1" id="S27T7U1500">m</span></span>,:)</span> = <span class="mxinfo " id="T7:U1068"><span class="mxinfo " id="T7:U1069"><span class="fcn" id="F902N4:B1504">Rtil</span>(<span class="var type1" id="S86T16U1505">phiInv</span>,<span class="mxinfo " id="T7:U1071">0</span>,<span class="mxinfo " id="T7:U1072"><span class="var type1" id="S25T7U1507">n</span></span>,<span class="var type1" id="S27T7U1508">m</span>)</span>*<span class="mxinfo " id="T7:U1075"><span class="var type1" id="S77T1U1510">rd</span>(<span class="mxinfo " id="T7:U1077">1:<span class="var type1" id="S27T7U1513">m</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,287" id="srcline287">287</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S88T7U1516">ii</span>=<span class="mxinfo " id="T7:U1080">1</span>:(<span class="var type1" id="S37T7U1521">T</span>-1),</span></span>
<span class="srcline"><span class="lineno"><a href="51,288" id="srcline288">288</a></span><span class="line">        <span class="mxinfo " id="T24:U1082"><span class="mxinfo " id="T24:U1083"><span class="var type1" id="S98T1U1526">PhiInvRd</span>(<span class="mxinfo " id="T42:U1085"><span class="mxinfo " id="T7:U1086"><span class="var type1" id="S27T7U1529">m</span> + <span class="mxinfo " id="T7:U1088">(<span class="mxinfo " id="T7:U1089"><span class="var type1" id="S88T7U1533">ii</span>-<span class="mxinfo " id="T7:U1091">1</span></span>)*(<span class="mxinfo " id="T7:U1092"><span class="var type1" id="S27T7U1537">m</span>+<span class="var type1" id="S25T7U1538">n</span></span>)</span></span> + (<span class="mxinfo " id="T42:U1095">1:(<span class="var type1" id="S27T7U1544">m</span>+<span class="var type1" id="S25T7U1545">n</span>)</span>)</span>,:)</span> = <span class="mxinfo " id="T24:U1098"><span class="mxinfo " id="T33:U1099">[<span class="mxinfo " id="T60:U1100"><span class="mxinfo " id="T19:U1101"><span class="fcn" id="F908N3:B1551">Qtil</span>(<span class="var type1" id="S86T16U1552">phiInv</span>,<span class="var type1" id="S88T7U1553">ii</span>,<span class="var type1" id="S25T7U1554">n</span>,<span class="mxinfo " id="T7:U1105"><span class="var type1" id="S27T7U1555">m</span></span>)</span> <span class="mxinfo " id="T3:U1107"><span class="fcn" id="F911N5:B1557">Stil</span>(<span class="var type1" id="S86T16U1558">phiInv</span>,<span class="var type1" id="S88T7U1559">ii</span>,<span class="var type1" id="S25T7U1560">n</span>,<span class="var type1" id="S27T7U1561">m</span>)</span></span>; <span class="mxinfo " id="T42:U1112"><span class="mxinfo " id="T36:U1113"><span class="mxinfo " id="T3:U1114"><span class="fcn" id="F911N5:B1565">Stil</span>(<span class="var type1" id="S86T16U1566">phiInv</span>,<span class="var type1" id="S88T7U1567">ii</span>,<span class="var type1" id="S25T7U1568">n</span>,<span class="var type1" id="S27T7U1569">m</span>)</span>'</span> <span class="mxinfo " id="T7:U1119"><span class="fcn" id="F902N4:B1571">Rtil</span>(<span class="var type1" id="S86T16U1572">phiInv</span>,<span class="var type1" id="S88T7U1573">ii</span>,<span class="mxinfo " id="T7:U1122"><span class="var type1" id="S25T7U1574">n</span></span>,<span class="var type1" id="S27T7U1575">m</span>)</span></span>]</span>*<span class="mxinfo " id="T24:U1125"><span class="var type1" id="S77T1U1577">rd</span>(<span class="mxinfo " id="T42:U1127"><span class="mxinfo " id="T7:U1128"><span class="var type1" id="S27T7U1580">m</span> + <span class="mxinfo " id="T7:U1130">(<span class="mxinfo " id="T7:U1131"><span class="var type1" id="S88T7U1584">ii</span>-<span class="mxinfo " id="T7:U1133">1</span></span>)*(<span class="mxinfo " id="T7:U1134"><span class="var type1" id="S27T7U1588">m</span>+<span class="var type1" id="S25T7U1589">n</span></span>)</span></span> + (<span class="mxinfo " id="T42:U1137">1:(<span class="var type1" id="S27T7U1595">m</span>+<span class="var type1" id="S25T7U1596">n</span>)</span>)</span>,:)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,289" id="srcline289">289</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,290" id="srcline290">290</a></span><span class="line">    <span class="mxinfo " id="T3:U1140"><span class="mxinfo " id="T3:U1141"><span class="var type1" id="S98T1U1601">PhiInvRd</span>(<span class="mxinfo " id="T36:U1143"><span class="mxinfo " id="T7:U1144"><span class="var type1" id="S27T7U1604">m</span> + <span class="mxinfo " id="T7:U1146">(<span class="mxinfo " id="T7:U1147"><span class="var type1" id="S37T7U1608">T</span>-1</span>)*(<span class="mxinfo " id="T7:U1149"><span class="var type1" id="S27T7U1612">m</span>+<span class="var type1" id="S25T7U1613">n</span></span>)</span></span> +(<span class="mxinfo " id="T36:U1152">1:<span class="var type1" id="S25T7U1617">n</span></span>)</span>,:)</span> = <span class="mxinfo " id="T3:U1154"><span class="mxinfo " id="T19:U1155"><span class="fcn" id="F908N3:B1621">Qtil</span>(<span class="var type1" id="S86T16U1622">phiInv</span>,<span class="mxinfo " id="T7:U1157"><span class="var type1" id="S37T7U1623">T</span></span>,<span class="var type1" id="S25T7U1624">n</span>,<span class="mxinfo " id="T7:U1160"><span class="var type1" id="S27T7U1625">m</span></span>)</span>*<span class="mxinfo " id="T3:U1162"><span class="var type1" id="S77T1U1627">rd</span>(<span class="mxinfo " id="T36:U1164"><span class="mxinfo " id="T7:U1165"><span class="var type1" id="S27T7U1630">m</span> + <span class="mxinfo " id="T7:U1167">(<span class="mxinfo " id="T7:U1168"><span class="var type1" id="S37T7U1634">T</span>-1</span>)*(<span class="mxinfo " id="T7:U1170"><span class="var type1" id="S27T7U1638">m</span>+<span class="var type1" id="S25T7U1639">n</span></span>)</span></span> +(<span class="mxinfo " id="T36:U1173">1:<span class="var type1" id="S25T7U1643">n</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,291" id="srcline291">291</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,292" id="srcline292">292</a></span><span class="line">    <span class="comment">% and the RHS, -beta = rp - C*phiInv*rd</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,293" id="srcline293">293</a></span><span class="line">    <span class="mxinfo " id="T15:U1175"><span class="var type1" id="S99T15U1646">rhs</span> = <span class="mxinfo " id="T15:U1177"><span class="var type1" id="S73T15U1648">rp</span> - <span class="mxinfo " id="T15:U1179"><span class="fcn" id="F246N9:B1650">multByC</span>(<span class="var type1" id="S98T1U1651">PhiInvRd</span>,<span class="var type1" id="S11T19U1652">A</span>,<span class="var type1" id="S12T3U1653">B</span>,<span class="var type1" id="S22T20U1654">Ef</span>,<span class="var type1" id="S37T7U1655">T</span>,<span class="var type1" id="S25T7U1656">n</span>,<span class="var type1" id="S27T7U1657">m</span>,<span class="var type1" id="S36T7U1658">ellef</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,294" id="srcline294">294</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,295" id="srcline295">295</a></span><span class="line">    <span class="comment">% check it</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,296" id="srcline296">296</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U1661">flagChecking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,297" id="srcline297">297</a></span><span class="line">        <span class="mxinfo " id="T7:U1189"><span class="var type1" id="S101T7U1664">checkBeta</span> = <span class="mxinfo " id="T7:U1191">norm(<span class="mxinfo " id="T15:U1192"><span class="var type1" id="S99T15U1668">rhs</span> - (<span class="mxinfo " id="T15:U1194"><span class="var type1" id="S73T15U1671">rp</span> - <span class="mxinfo " id="T15:U1196"><span class="mxinfo " id="T18:U1197"><span class="var type1" id="S8T18U1674">C</span>*<span class="var type1" id="S86T16U1675">phiInv</span></span>*<span class="var type1" id="S77T1U1676">rd</span></span></span>)</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,298" id="srcline298">298</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,299" id="srcline299">299</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,300" id="srcline300">300</a></span><span class="line">    <span class="comment">% now find the blocks of the lower triangular Cholesky factorization of Y</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,301" id="srcline301">301</a></span><span class="line">    <span class="mxinfo " id="T62:U1201"><span class="var type1" id="S102T62U1679">L</span> = <span class="mxinfo " id="T62:U1203">zeros(<span class="mxinfo " id="T7:U1204"><span class="var type1" id="S30T7U1682">ne</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,302" id="srcline302">302</a></span><span class="line">    <span class="mxinfo " id="T19:U1206"><span class="mxinfo " id="T19:U1207"><span class="var type1" id="S102T62U1686">L</span>(<span class="mxinfo " id="T36:U1209"><span class="mxinfo " id="T7:U1210">1</span>:<span class="mxinfo " id="T7:U1211"><span class="var type1" id="S25T7U1689">n</span></span></span>,<span class="mxinfo " id="T36:U1213"><span class="mxinfo " id="T7:U1214">1</span>:<span class="mxinfo " id="T7:U1215"><span class="var type1" id="S25T7U1692">n</span></span></span>)</span> = <span class="mxinfo " id="T19:U1217">chol(<span class="mxinfo " id="T19:U1218"><span class="fcn" id="F1027N8:B1696">getSqBlk</span>(<span class="var type1" id="S92T62U1697">Y</span>,<span class="mxinfo " id="T7:U1220">1</span>,<span class="mxinfo " id="T7:U1221">1</span>,<span class="var type1" id="S25T7U1700">n</span>)</span>,<span class="string">'lower'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,303" id="srcline303">303</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S88T7U1704">ii</span>=<span class="mxinfo " id="T7:U1224">2</span>:<span class="var type1" id="S37T7U1707">T</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,304" id="srcline304">304</a></span><span class="line">        <span class="mxinfo " id="T19:U1226"><span class="mxinfo " id="T19:U1227"><span class="var type1" id="S102T62U1711">L</span>(<span class="mxinfo " id="T36:U1229"><span class="mxinfo " id="T7:U1230">(<span class="mxinfo " id="T7:U1231"><span class="var type1" id="S88T7U1716">ii</span>-<span class="mxinfo " id="T7:U1233">1</span></span>)*<span class="mxinfo " id="T7:U1234"><span class="var type1" id="S25T7U1718">n</span></span></span>+(<span class="mxinfo " id="T36:U1236">1:<span class="var type1" id="S25T7U1722">n</span></span>)</span>,<span class="mxinfo " id="T36:U1238"><span class="mxinfo " id="T7:U1239">(<span class="mxinfo " id="T7:U1240"><span class="var type1" id="S88T7U1727">ii</span>-<span class="mxinfo " id="T7:U1242">2</span></span>)*<span class="mxinfo " id="T7:U1243"><span class="var type1" id="S25T7U1729">n</span></span></span>+(<span class="mxinfo " id="T36:U1245">1:<span class="var type1" id="S25T7U1733">n</span></span>)</span>)</span> = <span class="mxinfo " id="T19:U1247"><span class="mxinfo " id="T19:U1248">linsolve(<span class="mxinfo " id="T19:U1249"><span class="fcn" id="F1027N8:B1738">getSqBlk</span>(<span class="var type1" id="S102T62U1739">L</span>,<span class="mxinfo " id="T7:U1251"><span class="var type1" id="S88T7U1741">ii</span>-<span class="mxinfo " id="T7:U1253">1</span></span>,<span class="mxinfo " id="T7:U1254"><span class="var type1" id="S88T7U1744">ii</span>-<span class="mxinfo " id="T7:U1256">1</span></span>,<span class="var type1" id="S25T7U1746">n</span>)</span>,<span class="mxinfo " id="T19:U1258"><span class="fcn" id="F1027N8:B1748">getSqBlk</span>(<span class="var type1" id="S92T62U1749">Y</span>,<span class="mxinfo " id="T7:U1260"><span class="var type1" id="S88T7U1751">ii</span>-<span class="mxinfo " id="T7:U1262">1</span></span>,<span class="var type1" id="S88T7U1753">ii</span>,<span class="var type1" id="S25T7U1754">n</span>)</span>,struct(<span class="string">'LT'</span>,true))</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,305" id="srcline305">305</a></span><span class="line">        <span class="mxinfo " id="T19:U1265"><span class="mxinfo " id="T19:U1266"><span class="var type1" id="S102T62U1763">L</span>(<span class="mxinfo " id="T36:U1268"><span class="mxinfo " id="T7:U1269">(<span class="mxinfo " id="T7:U1270"><span class="var type1" id="S88T7U1768">ii</span>-<span class="mxinfo " id="T7:U1272">1</span></span>)*<span class="mxinfo " id="T7:U1273"><span class="var type1" id="S25T7U1770">n</span></span></span>+(<span class="mxinfo " id="T36:U1275">1:<span class="var type1" id="S25T7U1774">n</span></span>)</span>,<span class="mxinfo " id="T36:U1277"><span class="mxinfo " id="T7:U1278">(<span class="mxinfo " id="T7:U1279"><span class="var type1" id="S88T7U1779">ii</span>-<span class="mxinfo " id="T7:U1281">1</span></span>)*<span class="mxinfo " id="T7:U1282"><span class="var type1" id="S25T7U1781">n</span></span></span>+(<span class="mxinfo " id="T36:U1284">1:<span class="var type1" id="S25T7U1785">n</span></span>)</span>)</span> = <span class="mxinfo " id="T19:U1286">chol(<span class="mxinfo " id="T19:U1287"><span class="mxinfo " id="T19:U1288"><span class="fcn" id="F1027N8:B1790">getSqBlk</span>(<span class="var type1" id="S92T62U1791">Y</span>,<span class="var type1" id="S88T7U1792">ii</span>,<span class="var type1" id="S88T7U1793">ii</span>,<span class="var type1" id="S25T7U1794">n</span>)</span> - <span class="mxinfo " id="T19:U1293"><span class="mxinfo " id="T19:U1294"><span class="fcn" id="F1027N8:B1797">getSqBlk</span>(<span class="var type1" id="S102T62U1798">L</span>,<span class="var type1" id="S88T7U1799">ii</span>,<span class="mxinfo " id="T7:U1297"><span class="var type1" id="S88T7U1801">ii</span>-<span class="mxinfo " id="T7:U1299">1</span></span>,<span class="var type1" id="S25T7U1803">n</span>)</span>*<span class="mxinfo " id="T19:U1301"><span class="mxinfo " id="T19:U1302"><span class="fcn" id="F1027N8:B1806">getSqBlk</span>(<span class="var type1" id="S102T62U1807">L</span>,<span class="var type1" id="S88T7U1808">ii</span>,<span class="mxinfo " id="T7:U1305"><span class="var type1" id="S88T7U1810">ii</span>-<span class="mxinfo " id="T7:U1307">1</span></span>,<span class="var type1" id="S25T7U1812">n</span>)</span>'</span></span></span>,<span class="string">'lower'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,306" id="srcline306">306</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,307" id="srcline307">307</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,308" id="srcline308">308</a></span><span class="line">    <span class="comment">% and the extra bits for terminal equality cons</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,309" id="srcline309">309</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S36T7U1817">ellef</span>&gt;0,</span></span>
<span class="srcline"><span class="lineno"><a href="51,310" id="srcline310">310</a></span><span class="line">        <span class="mxinfo " id="T20:U1310"><span class="mxinfo " id="T20:U1311"><span class="var type1" id="S102T62U1822">L</span>(<span class="mxinfo " id="T28:U1313"><span class="mxinfo " id="T7:U1314"><span class="mxinfo " id="T7:U1315"><span class="var type1" id="S37T7U1825">T</span></span>*<span class="mxinfo " id="T7:U1317"><span class="var type1" id="S25T7U1826">n</span></span></span>+(<span class="mxinfo " id="T28:U1319">1:<span class="var type1" id="S36T7U1830">ellef</span></span>)</span>,<span class="mxinfo " id="T36:U1321"><span class="mxinfo " id="T7:U1322">(<span class="mxinfo " id="T7:U1323"><span class="var type1" id="S37T7U1835">T</span>-1</span>)*<span class="mxinfo " id="T7:U1325"><span class="var type1" id="S25T7U1837">n</span></span></span>+(<span class="mxinfo " id="T36:U1327">1:<span class="var type1" id="S25T7U1841">n</span></span>)</span>)</span> = <span class="mxinfo " id="T20:U1329"><span class="mxinfo " id="T63:U1330">linsolve(<span class="mxinfo " id="T19:U1331"><span class="fcn" id="F1027N8:B1846">getSqBlk</span>(<span class="var type1" id="S102T62U1847">L</span>,<span class="mxinfo " id="T7:U1333"><span class="var type1" id="S37T7U1848">T</span></span>,<span class="mxinfo " id="T7:U1335"><span class="var type1" id="S37T7U1849">T</span></span>,<span class="var type1" id="S25T7U1850">n</span>)</span>,<span class="mxinfo " id="T63:U1338"><span class="var type1" id="S92T62U1852">Y</span>(<span class="mxinfo " id="T36:U1340"><span class="mxinfo " id="T7:U1341">(<span class="mxinfo " id="T7:U1342"><span class="var type1" id="S37T7U1857">T</span>-1</span>)*<span class="mxinfo " id="T7:U1344"><span class="var type1" id="S25T7U1859">n</span></span></span>+(<span class="mxinfo " id="T36:U1346">1:<span class="var type1" id="S25T7U1863">n</span></span>)</span>,<span class="mxinfo " id="T28:U1348"><span class="mxinfo " id="T7:U1349"><span class="mxinfo " id="T7:U1350"><span class="var type1" id="S37T7U1866">T</span></span>*<span class="mxinfo " id="T7:U1352"><span class="var type1" id="S25T7U1867">n</span></span></span>+(<span class="mxinfo " id="T28:U1354">1:<span class="var type1" id="S36T7U1871">ellef</span></span>)</span>)</span>,struct(<span class="string">'LT'</span>,true))</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,311" id="srcline311">311</a></span><span class="line">        <span class="mxinfo " id="T44:U1356"><span class="mxinfo " id="T44:U1357"><span class="var type1" id="S102T62U1880">L</span>(<span class="mxinfo " id="T28:U1359"><span class="mxinfo " id="T7:U1360"><span class="mxinfo " id="T7:U1361"><span class="var type1" id="S37T7U1883">T</span></span>*<span class="mxinfo " id="T7:U1363"><span class="var type1" id="S25T7U1884">n</span></span></span>+(<span class="mxinfo " id="T28:U1365">1:<span class="var type1" id="S36T7U1888">ellef</span></span>)</span>,<span class="mxinfo " id="T28:U1367"><span class="mxinfo " id="T7:U1368"><span class="mxinfo " id="T7:U1369"><span class="var type1" id="S37T7U1891">T</span></span>*<span class="mxinfo " id="T7:U1371"><span class="var type1" id="S25T7U1892">n</span></span></span>+(<span class="mxinfo " id="T28:U1373">1:<span class="var type1" id="S36T7U1896">ellef</span></span>)</span>)</span> = <span class="mxinfo " id="T44:U1375">chol(<span class="mxinfo " id="T44:U1376"><span class="mxinfo " id="T44:U1377"><span class="var type1" id="S92T62U1901">Y</span>(<span class="mxinfo " id="T28:U1379"><span class="mxinfo " id="T7:U1380"><span class="mxinfo " id="T7:U1381"><span class="var type1" id="S37T7U1904">T</span></span>*<span class="mxinfo " id="T7:U1383"><span class="var type1" id="S25T7U1905">n</span></span></span>+(<span class="mxinfo " id="T28:U1385">1:<span class="var type1" id="S36T7U1909">ellef</span></span>)</span>,<span class="mxinfo " id="T28:U1387"><span class="mxinfo " id="T7:U1388"><span class="mxinfo " id="T7:U1389"><span class="var type1" id="S37T7U1912">T</span></span>*<span class="mxinfo " id="T7:U1391"><span class="var type1" id="S25T7U1913">n</span></span></span>+(<span class="mxinfo " id="T28:U1393">1:<span class="var type1" id="S36T7U1917">ellef</span></span>)</span>)</span> - <span class="mxinfo " id="T44:U1395"><span class="mxinfo " id="T20:U1396"><span class="var type1" id="S102T62U1920">L</span>(<span class="mxinfo " id="T28:U1398"><span class="mxinfo " id="T7:U1399"><span class="mxinfo " id="T7:U1400"><span class="var type1" id="S37T7U1923">T</span></span>*<span class="mxinfo " id="T7:U1402"><span class="var type1" id="S25T7U1924">n</span></span></span>+(<span class="mxinfo " id="T28:U1404">1:<span class="var type1" id="S36T7U1928">ellef</span></span>)</span>,<span class="mxinfo " id="T36:U1406"><span class="mxinfo " id="T7:U1407">(<span class="mxinfo " id="T7:U1408"><span class="var type1" id="S37T7U1933">T</span>-1</span>)*<span class="mxinfo " id="T7:U1410"><span class="var type1" id="S25T7U1935">n</span></span></span>+(<span class="mxinfo " id="T36:U1412">1:<span class="var type1" id="S25T7U1939">n</span></span>)</span>)</span>*<span class="mxinfo " id="T63:U1414"><span class="mxinfo " id="T20:U1415"><span class="var type1" id="S102T62U1942">L</span>(<span class="mxinfo " id="T28:U1417"><span class="mxinfo " id="T7:U1418"><span class="mxinfo " id="T7:U1419"><span class="var type1" id="S37T7U1945">T</span></span>*<span class="mxinfo " id="T7:U1421"><span class="var type1" id="S25T7U1946">n</span></span></span>+(<span class="mxinfo " id="T28:U1423">1:<span class="var type1" id="S36T7U1950">ellef</span></span>)</span>,<span class="mxinfo " id="T36:U1425"><span class="mxinfo " id="T7:U1426">(<span class="mxinfo " id="T7:U1427"><span class="var type1" id="S37T7U1955">T</span>-1</span>)*<span class="mxinfo " id="T7:U1429"><span class="var type1" id="S25T7U1957">n</span></span></span>+(<span class="mxinfo " id="T36:U1431">1:<span class="var type1" id="S25T7U1961">n</span></span>)</span>)</span>'</span></span></span>,<span class="string">'lower'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,312" id="srcline312">312</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,313" id="srcline313">313</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,314" id="srcline314">314</a></span><span class="line">    <span class="comment">% now check the thing</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,315" id="srcline315">315</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U1965">flagChecking</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,316" id="srcline316">316</a></span><span class="line">        <span class="mxinfo " id="T7:U1434"><span class="var type1" id="S108T7U1968">checkL</span> = <span class="mxinfo " id="T7:U1436">norm(<span class="mxinfo " id="T62:U1437"><span class="mxinfo " id="T62:U1438"><span class="var type1" id="S102T62U1973">L</span>*<span class="mxinfo " id="T62:U1440"><span class="var type1" id="S102T62U1975">L</span>'</span></span>-<span class="var type1" id="S92T62U1976">Y</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,317" id="srcline317">317</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,318" id="srcline318">318</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,319" id="srcline319">319</a></span><span class="line">    <span class="comment">% solve (L*L')*dnu=rhs: part one: solve for t=L'*dnu</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,320" id="srcline320">320</a></span><span class="line">    <span class="mxinfo " id="T15:U1443"><span class="var type1" id="S109T15U1979">t</span> = <span class="mxinfo " id="T15:U1445">zeros(<span class="mxinfo " id="T7:U1446"><span class="var type1" id="S30T7U1982">ne</span></span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,321" id="srcline321">321</a></span><span class="line">    <span class="mxinfo " id="T36:U1448"><span class="mxinfo " id="T36:U1449"><span class="var type1" id="S109T15U1987">t</span>(<span class="mxinfo " id="T36:U1451"><span class="mxinfo " id="T7:U1452">1</span>:<span class="mxinfo " id="T7:U1453"><span class="var type1" id="S25T7U1990">n</span></span></span>)</span> = <span class="mxinfo " id="T3:U1455">linsolve(<span class="mxinfo " id="T19:U1456"><span class="fcn" id="F1027N8:B1994">getSqBlk</span>(<span class="var type1" id="S102T62U1995">L</span>,<span class="mxinfo " id="T7:U1458">1</span>,<span class="mxinfo " id="T7:U1459">1</span>,<span class="var type1" id="S25T7U1998">n</span>)</span>,<span class="mxinfo " id="T3:U1461"><span class="var type1" id="S99T15U2000">rhs</span>(<span class="mxinfo " id="T36:U1463"><span class="mxinfo " id="T7:U1464">1</span>:<span class="mxinfo " id="T7:U1465"><span class="var type1" id="S25T7U2003">n</span></span></span>)</span>,struct(<span class="string">'LT'</span>,true))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,322" id="srcline322">322</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S88T7U2011">ii</span>=<span class="mxinfo " id="T7:U1468">1</span>:(<span class="var type1" id="S37T7U2016">T</span>-1),</span></span>
<span class="srcline"><span class="lineno"><a href="51,323" id="srcline323">323</a></span><span class="line">        <span class="mxinfo " id="T36:U1470"><span class="mxinfo " id="T36:U1471"><span class="var type1" id="S109T15U2021">t</span>(<span class="mxinfo " id="T36:U1473"><span class="mxinfo " id="T7:U1474"><span class="var type1" id="S88T7U2024">ii</span>*<span class="mxinfo " id="T7:U1476"><span class="var type1" id="S25T7U2025">n</span></span></span> + (<span class="mxinfo " id="T36:U1478">1:<span class="var type1" id="S25T7U2029">n</span></span>)</span>)</span> = <span class="mxinfo " id="T3:U1480">linsolve(<span class="mxinfo " id="T19:U1481"><span class="fcn" id="F1027N8:B2033">getSqBlk</span>(<span class="var type1" id="S102T62U2034">L</span>,<span class="mxinfo " id="T7:U1483"><span class="var type1" id="S88T7U2036">ii</span>+<span class="mxinfo " id="T7:U1485">1</span></span>,<span class="mxinfo " id="T7:U1486"><span class="var type1" id="S88T7U2039">ii</span>+<span class="mxinfo " id="T7:U1488">1</span></span>,<span class="var type1" id="S25T7U2041">n</span>)</span>,<span class="mxinfo " id="T3:U1490"><span class="mxinfo " id="T3:U1491"><span class="var type1" id="S99T15U2044">rhs</span>(<span class="mxinfo " id="T36:U1493"><span class="mxinfo " id="T7:U1494"><span class="var type1" id="S88T7U2047">ii</span>*<span class="mxinfo " id="T7:U1496"><span class="var type1" id="S25T7U2048">n</span></span></span> + (<span class="mxinfo " id="T36:U1498">1:<span class="var type1" id="S25T7U2052">n</span></span>)</span>)</span> - <span class="mxinfo " id="T3:U1500"><span class="mxinfo " id="T19:U1501"><span class="fcn" id="F1027N8:B2055">getSqBlk</span>(<span class="var type1" id="S102T62U2056">L</span>,<span class="mxinfo " id="T7:U1503"><span class="var type1" id="S88T7U2058">ii</span>+<span class="mxinfo " id="T7:U1505">1</span></span>,<span class="var type1" id="S88T7U2060">ii</span>,<span class="var type1" id="S25T7U2061">n</span>)</span>*<span class="mxinfo " id="T3:U1508"><span class="var type1" id="S109T15U2063">t</span>(<span class="mxinfo " id="T36:U1510"><span class="mxinfo " id="T7:U1511">(<span class="mxinfo " id="T7:U1512"><span class="var type1" id="S88T7U2068">ii</span>-<span class="mxinfo " id="T7:U1514">1</span></span>)*<span class="mxinfo " id="T7:U1515"><span class="var type1" id="S25T7U2070">n</span></span></span> + (<span class="mxinfo " id="T36:U1517">1:<span class="var type1" id="S25T7U2074">n</span></span>)</span>)</span></span></span>,struct(<span class="string">'LT'</span>,true))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,324" id="srcline324">324</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,325" id="srcline325">325</a></span><span class="line">    <span class="comment">% final elements for terminal equalities</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,326" id="srcline326">326</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S36T7U2083">ellef</span>&gt;0,</span></span>
<span class="srcline"><span class="lineno"><a href="51,327" id="srcline327">327</a></span><span class="line">        <span class="mxinfo " id="T28:U1520"><span class="mxinfo " id="T28:U1521"><span class="var type1" id="S109T15U2088">t</span>(<span class="mxinfo " id="T28:U1523"><span class="mxinfo " id="T7:U1524"><span class="mxinfo " id="T7:U1525"><span class="var type1" id="S37T7U2091">T</span></span>*<span class="mxinfo " id="T7:U1527"><span class="var type1" id="S25T7U2092">n</span></span></span> + (<span class="mxinfo " id="T28:U1529">1:<span class="var type1" id="S36T7U2096">ellef</span></span>)</span>)</span> = <span class="mxinfo " id="T21:U1531">linsolve(<span class="mxinfo " id="T44:U1532"><span class="var type1" id="S102T62U2100">L</span>(<span class="mxinfo " id="T28:U1534"><span class="mxinfo " id="T7:U1535"><span class="mxinfo " id="T7:U1536"><span class="var type1" id="S37T7U2103">T</span></span>*<span class="mxinfo " id="T7:U1538"><span class="var type1" id="S25T7U2104">n</span></span></span>+(<span class="mxinfo " id="T28:U1540">1:<span class="var type1" id="S36T7U2108">ellef</span></span>)</span>,<span class="mxinfo " id="T28:U1542"><span class="mxinfo " id="T7:U1543"><span class="mxinfo " id="T7:U1544"><span class="var type1" id="S37T7U2111">T</span></span>*<span class="mxinfo " id="T7:U1546"><span class="var type1" id="S25T7U2112">n</span></span></span>+(<span class="mxinfo " id="T28:U1548">1:<span class="var type1" id="S36T7U2116">ellef</span></span>)</span>)</span>,<span class="mxinfo " id="T21:U1550"><span class="mxinfo " id="T21:U1551"><span class="var type1" id="S99T15U2119">rhs</span>(<span class="mxinfo " id="T28:U1553"><span class="mxinfo " id="T7:U1554"><span class="mxinfo " id="T7:U1555"><span class="var type1" id="S37T7U2122">T</span></span>*<span class="mxinfo " id="T7:U1557"><span class="var type1" id="S25T7U2123">n</span></span></span> + (<span class="mxinfo " id="T28:U1559">1:<span class="var type1" id="S36T7U2127">ellef</span></span>)</span>)</span> - <span class="mxinfo " id="T21:U1561"><span class="mxinfo " id="T20:U1562"><span class="var type1" id="S102T62U2130">L</span>(<span class="mxinfo " id="T28:U1564"><span class="mxinfo " id="T7:U1565"><span class="mxinfo " id="T7:U1566"><span class="var type1" id="S37T7U2133">T</span></span>*<span class="mxinfo " id="T7:U1568"><span class="var type1" id="S25T7U2134">n</span></span></span>+(<span class="mxinfo " id="T28:U1570">1:<span class="var type1" id="S36T7U2138">ellef</span></span>)</span>,<span class="mxinfo " id="T36:U1572"><span class="mxinfo " id="T7:U1573">(<span class="mxinfo " id="T7:U1574"><span class="var type1" id="S37T7U2143">T</span>-1</span>)*<span class="mxinfo " id="T7:U1576"><span class="var type1" id="S25T7U2145">n</span></span></span>+(<span class="mxinfo " id="T36:U1578">1:<span class="var type1" id="S25T7U2149">n</span></span>)</span>)</span>*<span class="mxinfo " id="T3:U1580"><span class="var type1" id="S109T15U2151">t</span>(<span class="mxinfo " id="T36:U1582"><span class="mxinfo " id="T7:U1583">(<span class="mxinfo " id="T7:U1584"><span class="var type1" id="S37T7U2156">T</span>-1</span>)*<span class="mxinfo " id="T7:U1586"><span class="var type1" id="S25T7U2158">n</span></span></span> + (<span class="mxinfo " id="T36:U1588">1:<span class="var type1" id="S25T7U2162">n</span></span>)</span>)</span></span></span>,struct(<span class="string">'LT'</span>,true))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,328" id="srcline328">328</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,329" id="srcline329">329</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,330" id="srcline330">330</a></span><span class="line">    <span class="comment">% check solve process</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,331" id="srcline331">331</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U2170">flagChecking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,332" id="srcline332">332</a></span><span class="line">        <span class="mxinfo " id="T7:U1591"><span class="var type1" id="S110T7U2173">check_t</span> = <span class="mxinfo " id="T7:U1593">norm(<span class="mxinfo " id="T15:U1594"><span class="mxinfo " id="T15:U1595"><span class="var type1" id="S102T62U2178">L</span>*<span class="var type1" id="S109T15U2179">t</span></span> - <span class="var type1" id="S99T15U2180">rhs</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,333" id="srcline333">333</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,334" id="srcline334">334</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,335" id="srcline335">335</a></span><span class="line">    <span class="comment">% now solve part two: L'*dnu = t;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,336" id="srcline336">336</a></span><span class="line">    <span class="mxinfo " id="T15:U1599"><span class="var type1" id="S111T15U2183">dnu</span> = <span class="mxinfo " id="T15:U1601">zeros(<span class="mxinfo " id="T7:U1602"><span class="var type1" id="S30T7U2186">ne</span></span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,337" id="srcline337">337</a></span><span class="line">    <span class="comment">% different start for terminal equality case</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,338" id="srcline338">338</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S36T7U2191">ellef</span>&gt;0,</span></span>
<span class="srcline"><span class="lineno"><a href="51,339" id="srcline339">339</a></span><span class="line">        <span class="mxinfo " id="T28:U1605"><span class="mxinfo " id="T28:U1606"><span class="var type1" id="S111T15U2196">dnu</span>(<span class="mxinfo " id="T28:U1608"><span class="mxinfo " id="T7:U1609"><span class="mxinfo " id="T7:U1610"><span class="var type1" id="S37T7U2199">T</span></span>*<span class="mxinfo " id="T7:U1612"><span class="var type1" id="S25T7U2200">n</span></span></span> + (<span class="mxinfo " id="T28:U1614">1:<span class="var type1" id="S36T7U2204">ellef</span></span>)</span>)</span> = <span class="mxinfo " id="T21:U1616">linsolve(<span class="mxinfo " id="T44:U1617"><span class="mxinfo " id="T44:U1618"><span class="var type1" id="S102T62U2209">L</span>(<span class="mxinfo " id="T28:U1620"><span class="mxinfo " id="T7:U1621"><span class="mxinfo " id="T7:U1622"><span class="var type1" id="S37T7U2212">T</span></span>*<span class="mxinfo " id="T7:U1624"><span class="var type1" id="S25T7U2213">n</span></span></span>+(<span class="mxinfo " id="T28:U1626">1:<span class="var type1" id="S36T7U2217">ellef</span></span>)</span>,<span class="mxinfo " id="T28:U1628"><span class="mxinfo " id="T7:U1629"><span class="mxinfo " id="T7:U1630"><span class="var type1" id="S37T7U2220">T</span></span>*<span class="mxinfo " id="T7:U1632"><span class="var type1" id="S25T7U2221">n</span></span></span>+(<span class="mxinfo " id="T28:U1634">1:<span class="var type1" id="S36T7U2225">ellef</span></span>)</span>)</span>'</span>,<span class="mxinfo " id="T21:U1636"><span class="var type1" id="S109T15U2227">t</span>(<span class="mxinfo " id="T28:U1638"><span class="mxinfo " id="T7:U1639"><span class="mxinfo " id="T7:U1640"><span class="var type1" id="S37T7U2230">T</span></span>*<span class="mxinfo " id="T7:U1642"><span class="var type1" id="S25T7U2231">n</span></span></span> + (<span class="mxinfo " id="T28:U1644">1:<span class="var type1" id="S36T7U2235">ellef</span></span>)</span>)</span>,struct(<span class="string">'UT'</span>,true))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,340" id="srcline340">340</a></span><span class="line">        <span class="mxinfo " id="T36:U1646"><span class="mxinfo " id="T36:U1647"><span class="var type1" id="S111T15U2244">dnu</span>(<span class="mxinfo " id="T36:U1649"><span class="mxinfo " id="T7:U1650">(<span class="mxinfo " id="T7:U1651"><span class="var type1" id="S37T7U2249">T</span>-1</span>)*<span class="mxinfo " id="T7:U1653"><span class="var type1" id="S25T7U2251">n</span></span></span> + (<span class="mxinfo " id="T36:U1655">1:<span class="var type1" id="S25T7U2255">n</span></span>)</span>)</span> = <span class="mxinfo " id="T3:U1657">linsolve(<span class="mxinfo " id="T19:U1658"><span class="mxinfo " id="T19:U1659"><span class="fcn" id="F1027N8:B2260">getSqBlk</span>(<span class="var type1" id="S102T62U2261">L</span>,<span class="mxinfo " id="T7:U1661"><span class="var type1" id="S37T7U2262">T</span></span>,<span class="mxinfo " id="T7:U1663"><span class="var type1" id="S37T7U2263">T</span></span>,<span class="var type1" id="S25T7U2264">n</span>)</span>'</span>,<span class="mxinfo " id="T3:U1666"><span class="mxinfo " id="T3:U1667"><span class="var type1" id="S109T15U2267">t</span>(<span class="mxinfo " id="T36:U1669"><span class="mxinfo " id="T7:U1670">(<span class="mxinfo " id="T7:U1671"><span class="var type1" id="S37T7U2272">T</span>-1</span>)*<span class="mxinfo " id="T7:U1673"><span class="var type1" id="S25T7U2274">n</span></span></span> + (<span class="mxinfo " id="T36:U1675">1:<span class="var type1" id="S25T7U2278">n</span></span>)</span>)</span> - <span class="mxinfo " id="T3:U1677"><span class="mxinfo " id="T63:U1678"><span class="mxinfo " id="T20:U1679"><span class="var type1" id="S102T62U2282">L</span>(<span class="mxinfo " id="T28:U1681"><span class="mxinfo " id="T7:U1682"><span class="mxinfo " id="T7:U1683"><span class="var type1" id="S37T7U2285">T</span></span>*<span class="mxinfo " id="T7:U1685"><span class="var type1" id="S25T7U2286">n</span></span></span>+(<span class="mxinfo " id="T28:U1687">1:<span class="var type1" id="S36T7U2290">ellef</span></span>)</span>,<span class="mxinfo " id="T36:U1689"><span class="mxinfo " id="T7:U1690">(<span class="mxinfo " id="T7:U1691"><span class="var type1" id="S37T7U2295">T</span>-1</span>)*<span class="mxinfo " id="T7:U1693"><span class="var type1" id="S25T7U2297">n</span></span></span>+(<span class="mxinfo " id="T36:U1695">1:<span class="var type1" id="S25T7U2301">n</span></span>)</span>)</span>'</span>*<span class="mxinfo " id="T21:U1697"><span class="var type1" id="S111T15U2303">dnu</span>(<span class="mxinfo " id="T28:U1699"><span class="mxinfo " id="T7:U1700"><span class="mxinfo " id="T7:U1701"><span class="var type1" id="S37T7U2306">T</span></span>*<span class="mxinfo " id="T7:U1703"><span class="var type1" id="S25T7U2307">n</span></span></span> + (<span class="mxinfo " id="T28:U1705">1:<span class="var type1" id="S36T7U2311">ellef</span></span>)</span>)</span></span></span>,struct(<span class="string">'UT'</span>,true))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,341" id="srcline341">341</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,342" id="srcline342">342</a></span><span class="line">        <span class="var type0" id="S111T0U2321">dnu</span>((<span class="var type0" id="S37T0U2326">T</span>-1)*<span class="var type0" id="S25T0U2328">n</span> + (1:<span class="var type0" id="S25T0U2332">n</span>)) = linsolve(getSqBlk(<span class="var type0" id="S102T0U2338">L</span>,<span class="var type0" id="S37T0U2339">T</span>,<span class="var type0" id="S37T0U2340">T</span>,<span class="var type0" id="S25T0U2341">n</span>)',<span class="var type0" id="S109T0U2343">t</span>((<span class="var type0" id="S37T0U2348">T</span>-1)*<span class="var type0" id="S25T0U2350">n</span> + (1:<span class="var type0" id="S25T0U2354">n</span>)),struct(<span class="string">'UT'</span>,true));</span></span>
<span class="srcline"><span class="lineno"><a href="51,343" id="srcline343">343</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,344" id="srcline344">344</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S88T7U2362">ii</span>=(<span class="mxinfo " id="T7:U1708"><span class="var type1" id="S37T7U2367">T</span>-1</span>):<span class="mxinfo " id="T7:U1710">-1</span>:1,</span></span>
<span class="srcline"><span class="lineno"><a href="51,345" id="srcline345">345</a></span><span class="line">        <span class="mxinfo " id="T36:U1711"><span class="mxinfo " id="T36:U1712"><span class="var type1" id="S111T15U2375">dnu</span>(<span class="mxinfo " id="T36:U1714"><span class="mxinfo " id="T7:U1715">(<span class="mxinfo " id="T7:U1716"><span class="var type1" id="S88T7U2380">ii</span>-<span class="mxinfo " id="T7:U1718">1</span></span>)*<span class="mxinfo " id="T7:U1719"><span class="var type1" id="S25T7U2382">n</span></span></span> + (<span class="mxinfo " id="T36:U1721">1:<span class="var type1" id="S25T7U2386">n</span></span>)</span>)</span> = <span class="mxinfo " id="T3:U1723">linsolve(<span class="mxinfo " id="T19:U1724"><span class="mxinfo " id="T19:U1725"><span class="fcn" id="F1027N8:B2391">getSqBlk</span>(<span class="var type1" id="S102T62U2392">L</span>,<span class="var type1" id="S88T7U2393">ii</span>,<span class="var type1" id="S88T7U2394">ii</span>,<span class="var type1" id="S25T7U2395">n</span>)</span>'</span>,<span class="mxinfo " id="T3:U1730"><span class="mxinfo " id="T3:U1731"><span class="var type1" id="S109T15U2398">t</span>(<span class="mxinfo " id="T36:U1733"><span class="mxinfo " id="T7:U1734">(<span class="mxinfo " id="T7:U1735"><span class="var type1" id="S88T7U2403">ii</span>-<span class="mxinfo " id="T7:U1737">1</span></span>)*<span class="mxinfo " id="T7:U1738"><span class="var type1" id="S25T7U2405">n</span></span></span> + (<span class="mxinfo " id="T36:U1740">1:<span class="var type1" id="S25T7U2409">n</span></span>)</span>)</span> - <span class="mxinfo " id="T3:U1742"><span class="mxinfo " id="T19:U1743"><span class="mxinfo " id="T19:U1744"><span class="fcn" id="F1027N8:B2413">getSqBlk</span>(<span class="var type1" id="S102T62U2414">L</span>,<span class="mxinfo " id="T7:U1746"><span class="var type1" id="S88T7U2416">ii</span>+<span class="mxinfo " id="T7:U1748">1</span></span>,<span class="var type1" id="S88T7U2418">ii</span>,<span class="var type1" id="S25T7U2419">n</span>)</span>'</span>*<span class="mxinfo " id="T3:U1751"><span class="var type1" id="S111T15U2421">dnu</span>(<span class="mxinfo " id="T36:U1753"><span class="mxinfo " id="T7:U1754">(<span class="var type1" id="S88T7U2425">ii</span>)*<span class="mxinfo " id="T7:U1756"><span class="var type1" id="S25T7U2426">n</span></span></span> + (<span class="mxinfo " id="T36:U1758">1:<span class="var type1" id="S25T7U2430">n</span></span>)</span>)</span></span></span>,struct(<span class="string">'UT'</span>,true))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,346" id="srcline346">346</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,347" id="srcline347">347</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,348" id="srcline348">348</a></span><span class="line">    <span class="comment">% check the whole solve worked</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,349" id="srcline349">349</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U2438">flagChecking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,350" id="srcline350">350</a></span><span class="line">        <span class="mxinfo " id="T7:U1761"><span class="var type1" id="S112T7U2441">check_dnu</span> = <span class="mxinfo " id="T7:U1763">norm(<span class="mxinfo " id="T15:U1764"><span class="mxinfo " id="T15:U1765"><span class="var type1" id="S92T62U2446">Y</span>*<span class="var type1" id="S111T15U2447">dnu</span></span> - <span class="var type1" id="S99T15U2448">rhs</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,351" id="srcline351">351</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,352" id="srcline352">352</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,353" id="srcline353">353</a></span><span class="line">    <span class="comment">% now solve for dz</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,354" id="srcline354">354</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S42T4U2451">flagPhiIsDiag</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,355" id="srcline355">355</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,356" id="srcline356">356</a></span><span class="line">        <span class="comment">% solve for dz assuming PhiInv diagonal</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,357" id="srcline357">357</a></span><span class="line">        <span class="mxinfo " id="T1:U1770"><span class="var type1" id="S62T1U2454">dz</span> = <span class="mxinfo " id="T1:U1772"><span class="mxinfo " id="T1:U1773">diag(<span class="var type1" id="S86T16U2458">phiInv</span>)</span>.*(<span class="mxinfo " id="T1:U1775"><span class="mxinfo " id="T1:U1776">-<span class="var type1" id="S77T1U2462">rd</span></span>-<span class="mxinfo " id="T1:U1778"><span class="mxinfo " id="T43:U1779"><span class="var type1" id="S8T18U2465">C</span>'</span>*<span class="var type1" id="S111T15U2466">dnu</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,358" id="srcline358">358</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,359" id="srcline359">359</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,360" id="srcline360">360</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,361" id="srcline361">361</a></span><span class="line">        <span class="comment">% form the vector to be multiplied, for shorthand</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,362" id="srcline362">362</a></span><span class="line">        <span class="mxinfo " id="T1:U1782"><span class="var type1" id="S113T1U2470">v</span> = (<span class="mxinfo " id="T1:U1784"><span class="mxinfo " id="T1:U1785">-<span class="var type1" id="S77T1U2474">rd</span></span>-<span class="mxinfo " id="T1:U1787"><span class="mxinfo " id="T43:U1788"><span class="var type1" id="S8T18U2477">C</span>'</span>*<span class="var type1" id="S111T15U2478">dnu</span></span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,363" id="srcline363">363</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,364" id="srcline364">364</a></span><span class="line">        <span class="comment">% now form PhiInv * rd in preparation for making the RHS (-beta)</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,365" id="srcline365">365</a></span><span class="line">        <span class="mxinfo " id="T7:U1791"><span class="mxinfo " id="T7:U1792"><span class="var type1" id="S62T1U2482">dz</span>(<span class="mxinfo " id="T7:U1794">1:<span class="var type1" id="S27T7U2485">m</span></span>,:)</span> = <span class="mxinfo " id="T7:U1796"><span class="mxinfo " id="T7:U1797"><span class="fcn" id="F902N4:B2489">Rtil</span>(<span class="var type1" id="S86T16U2490">phiInv</span>,<span class="mxinfo " id="T7:U1799">1</span>,<span class="mxinfo " id="T7:U1800"><span class="var type1" id="S25T7U2492">n</span></span>,<span class="var type1" id="S27T7U2493">m</span>)</span>*<span class="mxinfo " id="T7:U1803"><span class="var type1" id="S113T1U2495">v</span>(<span class="mxinfo " id="T7:U1805">1:<span class="var type1" id="S27T7U2498">m</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,366" id="srcline366">366</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S88T7U2501">ii</span>=<span class="mxinfo " id="T7:U1808">1</span>:(<span class="var type1" id="S37T7U2506">T</span>-1),</span></span>
<span class="srcline"><span class="lineno"><a href="51,367" id="srcline367">367</a></span><span class="line">            <span class="mxinfo " id="T24:U1810"><span class="mxinfo " id="T24:U1811"><span class="var type1" id="S62T1U2511">dz</span>(<span class="mxinfo " id="T42:U1813"><span class="mxinfo " id="T7:U1814"><span class="var type1" id="S27T7U2514">m</span> + <span class="mxinfo " id="T7:U1816">(<span class="mxinfo " id="T7:U1817"><span class="var type1" id="S88T7U2518">ii</span>-<span class="mxinfo " id="T7:U1819">1</span></span>)*(<span class="mxinfo " id="T7:U1820"><span class="var type1" id="S27T7U2522">m</span>+<span class="var type1" id="S25T7U2523">n</span></span>)</span></span> + (<span class="mxinfo " id="T42:U1823">1:(<span class="var type1" id="S27T7U2529">m</span>+<span class="var type1" id="S25T7U2530">n</span>)</span>)</span>,:)</span> = <span class="mxinfo " id="T24:U1826"><span class="mxinfo " id="T33:U1827">[<span class="mxinfo " id="T60:U1828"><span class="mxinfo " id="T19:U1829"><span class="fcn" id="F908N3:B2536">Qtil</span>(<span class="var type1" id="S86T16U2537">phiInv</span>,<span class="var type1" id="S88T7U2538">ii</span>,<span class="var type1" id="S25T7U2539">n</span>,<span class="mxinfo " id="T7:U1833"><span class="var type1" id="S27T7U2540">m</span></span>)</span> <span class="mxinfo " id="T3:U1835"><span class="fcn" id="F911N5:B2542">Stil</span>(<span class="var type1" id="S86T16U2543">phiInv</span>,<span class="var type1" id="S88T7U2544">ii</span>,<span class="var type1" id="S25T7U2545">n</span>,<span class="var type1" id="S27T7U2546">m</span>)</span></span>; <span class="mxinfo " id="T42:U1840"><span class="mxinfo " id="T36:U1841"><span class="mxinfo " id="T3:U1842"><span class="fcn" id="F911N5:B2550">Stil</span>(<span class="var type1" id="S86T16U2551">phiInv</span>,<span class="var type1" id="S88T7U2552">ii</span>,<span class="var type1" id="S25T7U2553">n</span>,<span class="var type1" id="S27T7U2554">m</span>)</span>'</span> <span class="mxinfo " id="T7:U1847"><span class="fcn" id="F902N4:B2556">Rtil</span>(<span class="var type1" id="S86T16U2557">phiInv</span>,<span class="var type1" id="S88T7U2558">ii</span>,<span class="mxinfo " id="T7:U1850"><span class="var type1" id="S25T7U2559">n</span></span>,<span class="var type1" id="S27T7U2560">m</span>)</span></span>]</span>*<span class="mxinfo " id="T24:U1853"><span class="var type1" id="S113T1U2562">v</span>(<span class="mxinfo " id="T42:U1855"><span class="mxinfo " id="T7:U1856"><span class="var type1" id="S27T7U2565">m</span> + <span class="mxinfo " id="T7:U1858">(<span class="mxinfo " id="T7:U1859"><span class="var type1" id="S88T7U2569">ii</span>-<span class="mxinfo " id="T7:U1861">1</span></span>)*(<span class="mxinfo " id="T7:U1862"><span class="var type1" id="S27T7U2573">m</span>+<span class="var type1" id="S25T7U2574">n</span></span>)</span></span> + (<span class="mxinfo " id="T42:U1865">1:(<span class="var type1" id="S27T7U2580">m</span>+<span class="var type1" id="S25T7U2581">n</span>)</span>)</span>,:)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,368" id="srcline368">368</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,369" id="srcline369">369</a></span><span class="line">        <span class="mxinfo " id="T3:U1868"><span class="mxinfo " id="T3:U1869"><span class="var type1" id="S62T1U2586">dz</span>(<span class="mxinfo " id="T36:U1871"><span class="mxinfo " id="T7:U1872"><span class="var type1" id="S27T7U2589">m</span> + <span class="mxinfo " id="T7:U1874">(<span class="mxinfo " id="T7:U1875"><span class="var type1" id="S37T7U2593">T</span>-1</span>)*(<span class="mxinfo " id="T7:U1877"><span class="var type1" id="S27T7U2597">m</span>+<span class="var type1" id="S25T7U2598">n</span></span>)</span></span> +(<span class="mxinfo " id="T36:U1880">1:<span class="var type1" id="S25T7U2602">n</span></span>)</span>,:)</span> = <span class="mxinfo " id="T3:U1882"><span class="mxinfo " id="T19:U1883"><span class="fcn" id="F908N3:B2606">Qtil</span>(<span class="var type1" id="S86T16U2607">phiInv</span>,<span class="mxinfo " id="T7:U1885"><span class="var type1" id="S37T7U2608">T</span></span>,<span class="var type1" id="S25T7U2609">n</span>,<span class="mxinfo " id="T7:U1888"><span class="var type1" id="S27T7U2610">m</span></span>)</span>*<span class="mxinfo " id="T3:U1890"><span class="var type1" id="S113T1U2612">v</span>(<span class="mxinfo " id="T36:U1892"><span class="mxinfo " id="T7:U1893"><span class="var type1" id="S27T7U2615">m</span> + <span class="mxinfo " id="T7:U1895">(<span class="mxinfo " id="T7:U1896"><span class="var type1" id="S37T7U2619">T</span>-1</span>)*(<span class="mxinfo " id="T7:U1898"><span class="var type1" id="S27T7U2623">m</span>+<span class="var type1" id="S25T7U2624">n</span></span>)</span></span> +(<span class="mxinfo " id="T36:U1901">1:<span class="var type1" id="S25T7U2628">n</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,370" id="srcline370">370</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,371" id="srcline371">371</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,372" id="srcline372">372</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,373" id="srcline373">373</a></span><span class="line">    <span class="comment">% check computation of Newton step</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,374" id="srcline374">374</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S46T4U2631">flagChecking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,375" id="srcline375">375</a></span><span class="line">        <span class="mxinfo " id="T65:U1904"><span class="var type1" id="S114T65U2634">checkPD</span> = <span class="mxinfo " id="T65:U1906">min(<span class="mxinfo " id="T70:U1907">eig(<span class="var type1" id="S64T16U2639">phi</span>)</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,376" id="srcline376">376</a></span><span class="line">        <span class="mxinfo " id="T7:U1909"><span class="var type1" id="S116T7U2642">checkNewton</span> = <span class="mxinfo " id="T7:U1911">norm(<span class="mxinfo " id="T72:U1912"><span class="mxinfo " id="T72:U1913"><span class="mxinfo " id="T71:U1914">[<span class="mxinfo " id="T82:U1915"><span class="var type1" id="S64T16U2649">phi</span> <span class="mxinfo " id="T43:U1917"><span class="var type1" id="S8T18U2651">C</span>'</span></span>;<span class="mxinfo " id="T83:U1919"><span class="var type1" id="S8T18U2653">C</span> <span class="mxinfo " id="T62:U1921">zeros(<span class="mxinfo " id="T7:U1922"><span class="var type1" id="S30T7U2656">ne</span></span>)</span></span>]</span>*<span class="mxinfo " id="T72:U1924">[<span class="var type1" id="S62T1U2659">dz</span>;<span class="var type1" id="S111T15U2661">dnu</span>]</span></span> + <span class="mxinfo " id="T72:U1927">[<span class="var type1" id="S77T1U2664">rd</span>; <span class="var type1" id="S73T15U2666">rp</span>]</span></span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,377" id="srcline377">377</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,378" id="srcline378">378</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,379" id="srcline379">379</a></span><span class="line">    <span class="comment">% line search</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,380" id="srcline380">380</a></span><span class="line">    <span class="mxinfo " id="T7:U1930"><span class="var type1" id="S117T7U2669">sMax</span> = <span class="mxinfo " id="T7:U1932">1.0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,381" id="srcline381">381</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,382" id="srcline382">382</a></span><span class="line">    <span class="comment">% part 1 - reduce until feasible</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,383" id="srcline383">383</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S118T7U2673">jj</span>=<span class="mxinfo " id="T7:U1934">1</span>:10,</span></span>
<span class="srcline"><span class="lineno"><a href="51,384" id="srcline384">384</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,385" id="srcline385">385</a></span><span class="line">        <span class="mxinfo " id="T1:U1935"><span class="var type1" id="S119T1U2679">zFar</span> = <span class="mxinfo " id="T1:U1937"><span class="var type1" id="S2T1U2681">z</span> + <span class="mxinfo " id="T1:U1939"><span class="var type1" id="S117T7U2683">sMax</span>*<span class="var type1" id="S62T1U2684">dz</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,386" id="srcline386">386</a></span><span class="line">        <span class="mxinfo " id="T12:U1942"><span class="var type1" id="S120T12U2687">iFar</span> = <span class="mxinfo " id="T12:U1944"><span class="var type1" id="S7T12U2689">h</span> - <span class="mxinfo " id="T12:U1946"><span class="fcn" id="F237N10:B2691">multByP</span>(<span class="var type1" id="S119T1U2692">zFar</span>,<span class="var type1" id="S13T20U2693">Fx</span>,<span class="var type1" id="S14T21U2694">Fu</span>,<span class="var type1" id="S15T22U2695">Ff</span>,<span class="var type1" id="S37T7U2696">T</span>,<span class="var type1" id="S25T7U2697">n</span>,<span class="var type1" id="S27T7U2698">m</span>,<span class="var type1" id="S33T7U2699">ell</span>,<span class="var type1" id="S35T7U2700">ellf</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,387" id="srcline387">387</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,388" id="srcline388">388</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T4:U1956">all(<span class="mxinfo " id="T37:U1957"><span class="var type1" id="S120T12U2706">iFar</span>&gt;<span class="mxinfo " id="T7:U1959">0</span></span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,389" id="srcline389">389</a></span><span class="line">            <span class="keyword">break</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,390" id="srcline390">390</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,391" id="srcline391">391</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,392" id="srcline392">392</a></span><span class="line">        <span class="mxinfo " id="T7:U1960"><span class="var type1" id="S117T7U2711">sMax</span> = <span class="mxinfo " id="T7:U1962"><span class="var type1" id="S117T7U2713">sMax</span>*<span class="mxinfo " id="T7:U1964">0.5</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,393" id="srcline393">393</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,394" id="srcline394">394</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,395" id="srcline395">395</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,396" id="srcline396">396</a></span><span class="line">    <span class="comment">% part 2 take a tiny step just to get the slope</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,397" id="srcline397">397</a></span><span class="line">    <span class="mxinfo " id="T7:U1965"><span class="var type1" id="S121T7U2717">s</span> = <span class="mxinfo " id="T7:U1967"><span class="var type1" id="S117T7U2719">sMax</span>/<span class="mxinfo " id="T7:U1969">100000</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,398" id="srcline398">398</a></span><span class="line">    <span class="mxinfo " id="T1:U1970"><span class="var type1" id="S122T1U2723">zNew</span> = <span class="mxinfo " id="T1:U1972"><span class="var type1" id="S2T1U2725">z</span> + <span class="mxinfo " id="T1:U1974"><span class="var type1" id="S121T7U2727">s</span>*<span class="var type1" id="S62T1U2728">dz</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,399" id="srcline399">399</a></span><span class="line">    <span class="mxinfo " id="T15:U1977"><span class="var type1" id="S123T15U2731">nuNew</span> = <span class="mxinfo " id="T15:U1979"><span class="var type1" id="S70T15U2733">nu</span> + <span class="mxinfo " id="T15:U1981"><span class="var type1" id="S121T7U2735">s</span>*<span class="var type1" id="S111T15U2736">dnu</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,400" id="srcline400">400</a></span><span class="line">    <span class="mxinfo " id="T12:U1984"><span class="var type1" id="S124T12U2739">iNew</span> = <span class="mxinfo " id="T12:U1986"><span class="var type1" id="S7T12U2741">h</span> - <span class="mxinfo " id="T12:U1988"><span class="fcn" id="F237N10:B2743">multByP</span>(<span class="var type1" id="S122T1U2744">zNew</span>,<span class="var type1" id="S13T20U2745">Fx</span>,<span class="var type1" id="S14T21U2746">Fu</span>,<span class="var type1" id="S15T22U2747">Ff</span>,<span class="var type1" id="S37T7U2748">T</span>,<span class="var type1" id="S25T7U2749">n</span>,<span class="var type1" id="S27T7U2750">m</span>,<span class="var type1" id="S33T7U2751">ell</span>,<span class="var type1" id="S35T7U2752">ellf</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,401" id="srcline401">401</a></span><span class="line">    <span class="comment">% new residuals</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,402" id="srcline402">402</a></span><span class="line">    <span class="mxinfo " id="T12:U1998"><span class="var type1" id="S125T12U2755">dNew</span> = <span class="mxinfo " id="T12:U2000"><span class="mxinfo " id="T7:U2001">1</span>./<span class="var type1" id="S124T12U2758">iNew</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,403" id="srcline403">403</a></span><span class="line">    <span class="mxinfo " id="T1:U2003"><span class="var type1" id="S126T1U2761">rdNew</span> = <span class="mxinfo " id="T1:U2005"><span class="mxinfo " id="T1:U2006"><span class="mxinfo " id="T1:U2007"><span class="mxinfo " id="T1:U2008"><span class="var type1" id="S54T1U2766">diagTwoH</span>.*<span class="var type1" id="S122T1U2767">zNew</span></span> + <span class="var type1" id="S5T1U2768">g</span></span> + <span class="mxinfo " id="T1:U2012"><span class="var type1" id="S51T27U2770">kappaPt</span>*<span class="var type1" id="S125T12U2771">dNew</span></span></span> + <span class="mxinfo " id="T1:U2015"><span class="mxinfo " id="T43:U2016"><span class="var type1" id="S8T18U2774">C</span>'</span>*<span class="var type1" id="S123T15U2775">nuNew</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,404" id="srcline404">404</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S45T4U2778">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,405" id="srcline405">405</a></span><span class="line">        [<span class="mxinfo " id="T1:U2020"><span class="var type1" id="S60T1U2782">dsNew</span></span>,<span class="mxinfo " id="T1:U2022"><span class="var type1" id="S61T1U2783">esNew</span></span>] = <span class="fcn" id="F299N6:B2785">calcDs</span>(<span class="var type1" id="S122T1U2786">zNew</span>,<span class="var type1" id="S20T16U2787">Ps</span>,<span class="var type1" id="S21T1U2788">hs</span>,<span class="mxinfo " id="T7:U2027"><span class="var type1" id="S50T7U2789">rho</span></span>,<span class="var type1" id="S47T4U2790">flagNoPade</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="51,406" id="srcline406">406</a></span><span class="line">        <span class="mxinfo " id="T1:U2030"><span class="var type1" id="S126T1U2793">rdNew</span> = <span class="mxinfo " id="T1:U2032"><span class="var type1" id="S126T1U2795">rdNew</span> + <span class="mxinfo " id="T1:U2034"><span class="mxinfo " id="T16:U2035"><span class="var type1" id="S20T16U2798">Ps</span>'</span>*<span class="var type1" id="S60T1U2799">dsNew</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,407" id="srcline407">407</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,408" id="srcline408">408</a></span><span class="line">    <span class="mxinfo " id="T15:U2038"><span class="var type1" id="S127T15U2802">rpNew</span> = <span class="mxinfo " id="T15:U2040"><span class="fcn" id="F247N7:B2804">calcRp</span>(<span class="var type1" id="S122T1U2805">zNew</span>,<span class="var type1" id="S9T15U2806">b</span>,<span class="var type1" id="S11T19U2807">A</span>,<span class="var type1" id="S12T3U2808">B</span>,<span class="var type1" id="S22T20U2809">Ef</span>,<span class="var type1" id="S37T7U2810">T</span>,<span class="var type1" id="S25T7U2811">n</span>,<span class="var type1" id="S27T7U2812">m</span>,<span class="var type1" id="S36T7U2813">ellef</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,409" id="srcline409">409</a></span><span class="line">    <span class="mxinfo " id="T7:U2050"><span class="var type1" id="S128T7U2816">rdMagNew</span> = <span class="mxinfo " id="T7:U2052">norm(<span class="var type1" id="S126T1U2819">rdNew</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,410" id="srcline410">410</a></span><span class="line">    <span class="mxinfo " id="T7:U2054"><span class="var type1" id="S129T7U2822">rpMagNew</span> = <span class="mxinfo " id="T7:U2056">norm(<span class="var type1" id="S127T15U2825">rpNew</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,411" id="srcline411">411</a></span><span class="line">    <span class="mxinfo " id="T7:U2058"><span class="var type1" id="S130T7U2828">rMagNew</span> = <span class="mxinfo " id="T7:U2060">norm(<span class="mxinfo " id="T21:U2061">[<span class="var type1" id="S128T7U2833">rdMagNew</span>;<span class="var type1" id="S129T7U2835">rpMagNew</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,412" id="srcline412">412</a></span><span class="line">    <span class="mxinfo " id="T7:U2064"><span class="var type1" id="S131T7U2838">gradRmag</span> = <span class="mxinfo " id="T7:U2066"><span class="mxinfo " id="T7:U2067">100000</span>*(<span class="mxinfo " id="T7:U2068"><span class="var type1" id="S130T7U2843">rMagNew</span>-<span class="var type1" id="S80T7U2844">rMag</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,413" id="srcline413">413</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,414" id="srcline414">414</a></span><span class="line">    <span class="comment">% debug - plot the darned thing</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,415" id="srcline415">415</a></span><span class="line"><span class="comment">%     dbgii=0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,416" id="srcline416">416</a></span><span class="line"><span class="comment">%     for s = linspace(-1.5*sMax,1.5*sMax,100),</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,417" id="srcline417">417</a></span><span class="line"><span class="comment">%         dbgii = dbgii+1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,418" id="srcline418">418</a></span><span class="line"><span class="comment">%         zNew = z + s*dz;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,419" id="srcline419">419</a></span><span class="line"><span class="comment">%         nuNew = nu + s*dnu;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,420" id="srcline420">420</a></span><span class="line"><span class="comment">%         iNew = h - multByP(zNew,Fx,Fu,Ff,T,n,m,ell,ellf);</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,421" id="srcline421">421</a></span><span class="line"><span class="comment">%         % new residuals</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,422" id="srcline422">422</a></span><span class="line"><span class="comment">%         dNew = 1./iNew;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,423" id="srcline423">423</a></span><span class="line"><span class="comment">%         rdNew = diagTwoH.*zNew + g + kappaPt*dNew + C'*nuNew;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,424" id="srcline424">424</a></span><span class="line"><span class="comment">%         if flagUseSoftCons,</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,425" id="srcline425">425</a></span><span class="line"><span class="comment">%             [dsNew,esNew] = calcDs(zNew,Ps,hs,rho,flagNoPade);</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,426" id="srcline426">426</a></span><span class="line"><span class="comment">%             rdNew = rdNew + Ps'*dsNew;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,427" id="srcline427">427</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,428" id="srcline428">428</a></span><span class="line"><span class="comment">%         rpNew = calcRp(zNew,b,A,B,Ef,T,n,m,ellef);</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,429" id="srcline429">429</a></span><span class="line"><span class="comment">%         rdMagNew = norm(rdNew);</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,430" id="srcline430">430</a></span><span class="line"><span class="comment">%         rpMagNew = norm(rpNew);</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,431" id="srcline431">431</a></span><span class="line"><span class="comment">%         rMagNew = norm([rdMagNew;rpMagNew]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,432" id="srcline432">432</a></span><span class="line"><span class="comment">%         dbgs(dbgii)=s;</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,433" id="srcline433">433</a></span><span class="line"><span class="comment">%         dbgr(dbgii,:)=[rdNew' rpNew'];</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,434" id="srcline434">434</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,435" id="srcline435">435</a></span><span class="line"><span class="comment">%     figure(kk)</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,436" id="srcline436">436</a></span><span class="line"><span class="comment">%     plot(dbgs,dbgr)</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,437" id="srcline437">437</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,438" id="srcline438">438</a></span><span class="line">    <span class="comment">% part 3 - backtracking</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,439" id="srcline439">439</a></span><span class="line">    <span class="mxinfo " id="T7:U2071"><span class="var type1" id="S121T7U2847">s</span> = <span class="var type1" id="S117T7U2848">sMax</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,440" id="srcline440">440</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S118T7U2851">jj</span>=<span class="mxinfo " id="T7:U2075">1</span>:20,</span></span>
<span class="srcline"><span class="lineno"><a href="51,441" id="srcline441">441</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,442" id="srcline442">442</a></span><span class="line">        <span class="mxinfo " id="T1:U2076"><span class="var type1" id="S122T1U2857">zNew</span> = <span class="mxinfo " id="T1:U2078"><span class="var type1" id="S2T1U2859">z</span> + <span class="mxinfo " id="T1:U2080"><span class="var type1" id="S121T7U2861">s</span>*<span class="var type1" id="S62T1U2862">dz</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,443" id="srcline443">443</a></span><span class="line">        <span class="mxinfo " id="T15:U2083"><span class="var type1" id="S123T15U2865">nuNew</span> = <span class="mxinfo " id="T15:U2085"><span class="var type1" id="S70T15U2867">nu</span> + <span class="mxinfo " id="T15:U2087"><span class="var type1" id="S121T7U2869">s</span>*<span class="var type1" id="S111T15U2870">dnu</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,444" id="srcline444">444</a></span><span class="line">        <span class="mxinfo " id="T12:U2090"><span class="var type1" id="S124T12U2873">iNew</span> = <span class="mxinfo " id="T12:U2092"><span class="var type1" id="S7T12U2875">h</span> - <span class="mxinfo " id="T12:U2094"><span class="fcn" id="F237N10:B2877">multByP</span>(<span class="var type1" id="S122T1U2878">zNew</span>,<span class="var type1" id="S13T20U2879">Fx</span>,<span class="var type1" id="S14T21U2880">Fu</span>,<span class="var type1" id="S15T22U2881">Ff</span>,<span class="var type1" id="S37T7U2882">T</span>,<span class="var type1" id="S25T7U2883">n</span>,<span class="var type1" id="S27T7U2884">m</span>,<span class="var type1" id="S33T7U2885">ell</span>,<span class="var type1" id="S35T7U2886">ellf</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,445" id="srcline445">445</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,446" id="srcline446">446</a></span><span class="line">        <span class="comment">% new residuals</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,447" id="srcline447">447</a></span><span class="line">        <span class="mxinfo " id="T12:U2104"><span class="var type1" id="S125T12U2889">dNew</span> = <span class="mxinfo " id="T12:U2106"><span class="mxinfo " id="T7:U2107">1</span>./<span class="var type1" id="S124T12U2892">iNew</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,448" id="srcline448">448</a></span><span class="line">        <span class="mxinfo " id="T1:U2109"><span class="var type1" id="S126T1U2895">rdNew</span> = <span class="mxinfo " id="T1:U2111"><span class="mxinfo " id="T1:U2112"><span class="mxinfo " id="T1:U2113"><span class="mxinfo " id="T1:U2114"><span class="var type1" id="S54T1U2900">diagTwoH</span>.*<span class="var type1" id="S122T1U2901">zNew</span></span> + <span class="var type1" id="S5T1U2902">g</span></span> + <span class="mxinfo " id="T1:U2118"><span class="var type1" id="S51T27U2904">kappaPt</span>*<span class="var type1" id="S125T12U2905">dNew</span></span></span> + <span class="mxinfo " id="T1:U2121"><span class="mxinfo " id="T43:U2122"><span class="var type1" id="S8T18U2908">C</span>'</span>*<span class="var type1" id="S123T15U2909">nuNew</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,449" id="srcline449">449</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S45T4U2912">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,450" id="srcline450">450</a></span><span class="line">            [<span class="mxinfo " id="T1:U2126"><span class="var type1" id="S60T1U2916">dsNew</span></span>,<span class="mxinfo " id="T1:U2128"><span class="var type1" id="S61T1U2917">esNew</span></span>] = <span class="fcn" id="F299N6:B2919">calcDs</span>(<span class="var type1" id="S122T1U2920">zNew</span>,<span class="var type1" id="S20T16U2921">Ps</span>,<span class="var type1" id="S21T1U2922">hs</span>,<span class="mxinfo " id="T7:U2133"><span class="var type1" id="S50T7U2923">rho</span></span>,<span class="var type1" id="S47T4U2924">flagNoPade</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="51,451" id="srcline451">451</a></span><span class="line">            <span class="mxinfo " id="T1:U2136"><span class="var type1" id="S126T1U2927">rdNew</span> = <span class="mxinfo " id="T1:U2138"><span class="var type1" id="S126T1U2929">rdNew</span> + <span class="mxinfo " id="T1:U2140"><span class="mxinfo " id="T16:U2141"><span class="var type1" id="S20T16U2932">Ps</span>'</span>*<span class="var type1" id="S60T1U2933">dsNew</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,452" id="srcline452">452</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,453" id="srcline453">453</a></span><span class="line">        <span class="mxinfo " id="T15:U2144"><span class="var type1" id="S127T15U2936">rpNew</span> = <span class="mxinfo " id="T15:U2146"><span class="fcn" id="F247N7:B2938">calcRp</span>(<span class="var type1" id="S122T1U2939">zNew</span>,<span class="var type1" id="S9T15U2940">b</span>,<span class="var type1" id="S11T19U2941">A</span>,<span class="var type1" id="S12T3U2942">B</span>,<span class="var type1" id="S22T20U2943">Ef</span>,<span class="var type1" id="S37T7U2944">T</span>,<span class="var type1" id="S25T7U2945">n</span>,<span class="var type1" id="S27T7U2946">m</span>,<span class="var type1" id="S36T7U2947">ellef</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,454" id="srcline454">454</a></span><span class="line">        <span class="mxinfo " id="T7:U2156"><span class="var type1" id="S128T7U2950">rdMagNew</span> = <span class="mxinfo " id="T7:U2158">norm(<span class="var type1" id="S126T1U2953">rdNew</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,455" id="srcline455">455</a></span><span class="line">        <span class="mxinfo " id="T7:U2160"><span class="var type1" id="S129T7U2956">rpMagNew</span> = <span class="mxinfo " id="T7:U2162">norm(<span class="var type1" id="S127T15U2959">rpNew</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,456" id="srcline456">456</a></span><span class="line">        <span class="mxinfo " id="T7:U2164"><span class="var type1" id="S130T7U2962">rMagNew</span> = <span class="mxinfo " id="T7:U2166">norm(<span class="mxinfo " id="T21:U2167">[<span class="var type1" id="S128T7U2967">rdMagNew</span>;<span class="var type1" id="S129T7U2969">rpMagNew</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,457" id="srcline457">457</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,458" id="srcline458">458</a></span><span class="line">        <span class="comment">%[kk jj rMagNew  (rMag + 0.4*s*gradRmag)]</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,459" id="srcline459">459</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,460" id="srcline460">460</a></span><span class="line">        <span class="comment">% test</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,461" id="srcline461">461</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T4:U2170"><span class="var type1" id="S130T7U2973">rMagNew</span> &lt; <span class="mxinfo " id="T7:U2172"><span class="var type1" id="S80T7U2975">rMag</span> + <span class="mxinfo " id="T7:U2174"><span class="mxinfo " id="T7:U2175"><span class="mxinfo " id="T7:U2176">0.6</span>*<span class="var type1" id="S121T7U2979">s</span></span>*<span class="var type1" id="S131T7U2980">gradRmag</span></span></span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,462" id="srcline462">462</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="51,463" id="srcline463">463</a></span><span class="line">            <span class="comment">% update</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,464" id="srcline464">464</a></span><span class="line">            <span class="mxinfo " id="T1:U2179"><span class="var type1" id="S2T1U2983">z</span> = <span class="var type1" id="S122T1U2984">zNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,465" id="srcline465">465</a></span><span class="line">            <span class="mxinfo " id="T15:U2182"><span class="var type1" id="S70T15U2987">nu</span> = <span class="var type1" id="S123T15U2988">nuNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,466" id="srcline466">466</a></span><span class="line">            <span class="mxinfo " id="T12:U2185"><span class="var type1" id="S71T12U2991">d</span> = <span class="var type1" id="S125T12U2992">dNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,467" id="srcline467">467</a></span><span class="line">            <span class="mxinfo " id="T1:U2188"><span class="var type1" id="S77T1U2995">rd</span> = <span class="var type1" id="S126T1U2996">rdNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,468" id="srcline468">468</a></span><span class="line">            <span class="mxinfo " id="T15:U2191"><span class="var type1" id="S73T15U2999">rp</span> = <span class="var type1" id="S127T15U3000">rpNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,469" id="srcline469">469</a></span><span class="line">            <span class="mxinfo " id="T7:U2194"><span class="var type1" id="S75T7U3003">rpMag</span> = <span class="var type1" id="S129T7U3004">rpMagNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,470" id="srcline470">470</a></span><span class="line">            <span class="mxinfo " id="T7:U2197"><span class="var type1" id="S79T7U3007">rdMag</span> = <span class="var type1" id="S128T7U3008">rdMagNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,471" id="srcline471">471</a></span><span class="line">            <span class="mxinfo " id="T7:U2200"><span class="var type1" id="S80T7U3011">rMag</span> = <span class="var type1" id="S130T7U3012">rMagNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,472" id="srcline472">472</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="51,473" id="srcline473">473</a></span><span class="line">            <span class="keyword">if</span> <span class="var type1" id="S45T4U3015">flagUseSoftCons</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,474" id="srcline474">474</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="51,475" id="srcline475">475</a></span><span class="line">                <span class="mxinfo " id="T1:U2204"><span class="var type1" id="S59T1U3018">ds</span> = <span class="var type1" id="S60T1U3019">dsNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,476" id="srcline476">476</a></span><span class="line">                <span class="mxinfo " id="T1:U2207"><span class="var type1" id="S58T1U3022">es</span> = <span class="var type1" id="S61T1U3023">esNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,477" id="srcline477">477</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="51,478" id="srcline478">478</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,479" id="srcline479">479</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="51,480" id="srcline480">480</a></span><span class="line">            <span class="comment">% do nothing</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,481" id="srcline481">481</a></span><span class="line">            <span class="comment">% lineSearchPass=[kk jj s rpMagNew rdMagNew]</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,482" id="srcline482">482</a></span><span class="line">            <span class="keyword">break</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,483" id="srcline483">483</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="51,484" id="srcline484">484</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,485" id="srcline485">485</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="51,486" id="srcline486">486</a></span><span class="line">            <span class="comment">%covg = false</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,487" id="srcline487">487</a></span><span class="line">            <span class="mxinfo " id="T7:U2210"><span class="var type1" id="S121T7U3028">s</span> = <span class="mxinfo " id="T7:U2212"><span class="var type1" id="S121T7U3030">s</span>*<span class="mxinfo " id="T7:U2214">0.6</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,488" id="srcline488">488</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="51,489" id="srcline489">489</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,490" id="srcline490">490</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="51,491" id="srcline491">491</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,492" id="srcline492">492</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,493" id="srcline493">493</a></span><span class="line">    <span class="comment">% optional early termination</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,494" id="srcline494">494</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T4:U2215"><span class="var type1" id="S80T7U3035">rMag</span> &lt; <span class="var type1" id="S48T7U3036">termTol</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="51,495" id="srcline495">495</a></span><span class="line">        <span class="mxinfo " id="T7:U2218"><span class="var type1" id="S81T7U3039">iterCount</span> = <span class="var type1" id="S82T7U3040">kk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="51,496" id="srcline496">496</a></span><span class="line">        <span class="keyword">break</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,497" id="srcline497">497</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,498" id="srcline498">498</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="51,499" id="srcline499">499</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,500" id="srcline500">500</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,501" id="srcline501">501</a></span><span class="line"><span class="comment">% information for output</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,502" id="srcline502">502</a></span><span class="line"><span class="mxinfo " id="T24:U2221"><span class="var type1" id="S3T24U3044">info</span> = <span class="mxinfo " id="T24:U2223">[<span class="var type1" id="S75T7U3047">rpMag</span>; </span></span><span class="comment"><span class="mxinfo " id="T24:U2221"><span class="mxinfo " id="T24:U2223">% primal residual, i.e. norm(C*z-b)</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,503" id="srcline503">503</a></span><span class="line"><span class="mxinfo " id="T24:U2221"><span class="mxinfo " id="T24:U2223">    <span class="var type1" id="S79T7U3049">rdMag</span>; </span></span><span class="comment"><span class="mxinfo " id="T24:U2221"><span class="mxinfo " id="T24:U2223">% dual residual, i.e. grad z</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,504" id="srcline504">504</a></span><span class="line"><span class="mxinfo " id="T24:U2221"><span class="mxinfo " id="T24:U2223">    <span class="var type1" id="S68T7U3051">initSolChoice</span>; </span></span><span class="comment"><span class="mxinfo " id="T24:U2221"><span class="mxinfo " id="T24:U2223">% which initial solution did I use?</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="51,505" id="srcline505">505</a></span><span class="line"><span class="mxinfo " id="T24:U2221"><span class="mxinfo " id="T24:U2223">    <span class="var type1" id="S81T7U3053">iterCount</span>]</span></span>; <span class="comment">% how many Newton iterations did I need?</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,506" id="srcline506">506</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,507" id="srcline507">507</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="51,508" id="srcline508">508</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="51,509" id="srcline509">509</a></span><span class="line"><span class="comment">% some functions to get block terms Q,R and S out of phi-inverse easily</span></span></span>
</pre>
